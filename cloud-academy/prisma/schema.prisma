generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Multi-tenant organization
model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  plan      String   @default("FREE") // FREE, PRO, ENTERPRISE
  
  // AWS Configuration (encrypted in production)
  awsRoleArn        String?
  awsExternalId     String?
  awsRegion         String   @default("us-east-1")
  defaultBucket     String?
  
  // Usage tracking
  bytesTransferred  BigInt   @default(0)
  bytesLimit        BigInt   @default(5368709120) // 5GB default
  
  // Stripe
  stripeCustomerId  String?
  stripeSubId       String?
  
  // AI Integration (BYOK - Bring Your Own Key)
  openaiApiKey      String?
  preferredModel    String?  @default("gpt-4.1") // GPT model for learning agent
  
  // Company Knowledge Base
  companyWebsite    String?
  companyContext    String?  // Scraped and summarized company info
  knowledgeUpdatedAt DateTime?
  
  // Desktop Agent
  agentApiKey       String?
  agentConnected    Boolean  @default(false)
  agentLastSeen     DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  users     User[]
  transfers Transfer[]
  buckets   Bucket[]
  secrets   Secret[]
  agentScans AgentScan[]
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String
  role          String    @default("USER") // SUPERUSER, ADMIN, USER, VIEWER
  isSuperuser   Boolean   @default(false)
  emailVerified DateTime? // null = not verified
  
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  transfers     Transfer[]
  chatThreads   ChatThread[]
  cloudFlows    CloudFlow[]
  
  @@index([tenantId])
}

model Bucket {
  id        String   @id @default(cuid())
  name      String
  region    String
  isDefault Boolean  @default(false)
  
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  transfers Transfer[]
  
  @@unique([tenantId, name])
  @@index([tenantId])
}

model Transfer {
  id          String   @id @default(cuid())
  
  // Source info
  fileName    String
  filePath    String
  fileSize    BigInt
  mimeType    String?
  
  // Destination
  s3Key       String
  bucketId    String
  bucket      Bucket   @relation(fields: [bucketId], references: [id])
  
  // Status: PENDING, UPLOADING, COMPLETED, FAILED, CANCELLED
  status      String   @default("PENDING")
  progress    Int      @default(0) // 0-100
  error       String?
  
  // Checksums
  localChecksum  String?
  s3Checksum     String?
  
  // Timing
  startedAt   DateTime?
  completedAt DateTime?
  
  // Relations
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
  @@index([userId])
  @@index([status])
}

// Knowledge base for RAG
model KnowledgeChunk {
  id        String   @id @default(cuid())
  source    String   // URL or document name
  title     String?
  content   String   // The text chunk
  embedding String   // JSON array of floats (OpenAI embedding)
  metadata  String?  // JSON for extra info
  
  createdAt DateTime @default(now())
  
  @@index([source])
}

// Chat threads for AI assistant
model ChatThread {
  id        String   @id @default(cuid())
  title     String   @default("New Chat")
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  messages  ChatMessage[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

model ChatMessage {
  id        String   @id @default(cuid())
  threadId  String
  thread    ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  
  role      String   // "user" or "assistant"
  content   String
  
  // Optional metadata for assistant responses
  type      String?  // "query", "s3_list", "insight", "chat", etc.
  data      String?  // JSON string for results, files, stats
  
  createdAt DateTime @default(now())
  
  @@index([threadId])
}

// Encrypted secrets storage (BYOK)
model Secret {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Secret type: AWS_ACCESS_KEY, AWS_SECRET_KEY, AWS_ROLE_ARN, OPENAI_API_KEY, etc.
  key       String
  // Encrypted value (iv:authTag:encryptedData)
  value     String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([tenantId, key])
  @@index([tenantId])
}

// Audit log for compliance
model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String?
  action    String
  resource  String
  details   String?
  ipAddress String?
  
  createdAt DateTime @default(now())
  
  @@index([tenantId])
  @@index([createdAt])
}

// Neo4j Graph Database Configuration per Tenant
model TenantNeo4jConfig {
  id          String   @id @default(cuid())
  tenantId    String   @unique
  
  // Connection settings (can be shared cluster or BYOD)
  boltUri     String   @default("bolt://neo4j:7687")
  username    String   @default("neo4j")
  password    String   // encrypted
  database    String   // tenant-specific database name
  
  // Config type
  configType  String   @default("SHARED") // SHARED, BYOD (Bring Your Own DB)
  
  // Limits
  maxNodes        Int      @default(100000)
  maxRelationships Int     @default(500000)
  gdsEnabled      Boolean  @default(false)
  embeddingsEnabled Boolean @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
}

// Graph Compute Usage Tracking for Billing
model GraphUsage {
  id                    String   @id @default(cuid())
  tenantId              String
  
  // Usage metrics
  computeSeconds        Int      @default(0)  // GDS algorithm execution time
  queriesExecuted       Int      @default(0)  // Cypher queries run
  nodesProcessed        Int      @default(0)  // Nodes touched
  relationshipsProcessed Int     @default(0)  // Relationships touched
  embeddingsGenerated   Int      @default(0)  // Vector embeddings created
  
  // Billing period
  periodStart           DateTime
  periodEnd             DateTime
  
  // Stripe sync
  stripeReported        Boolean  @default(false)
  stripeUsageRecordId   String?
  
  createdAt             DateTime @default(now())
  
  @@unique([tenantId, periodStart, periodEnd])
  @@index([tenantId])
}

// Graph Algorithm Execution Log
model GraphJobLog {
  id              String   @id @default(cuid())
  tenantId        String
  userId          String?
  
  // Job details
  algorithm       String   // pagerank, node2vec, similarity, etc.
  status          String   @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED
  
  // Metrics
  nodesProcessed  Int      @default(0)
  relsProcessed   Int      @default(0)
  executionMs     Int      @default(0)
  
  // Results
  resultSummary   String?  // JSON summary of results
  error           String?
  
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime @default(now())
  
  @@index([tenantId])
  @@index([status])
}

// ============================================
// CloudFabric‚Ñ¢ - Cloud Architecture Platform
// ============================================

// Cloud Resources - Unified view of all AWS resources
model CloudResource {
  id            String   @id @default(cuid())
  tenantId      String
  
  // Resource identification
  type          String   // EC2, S3, LAMBDA, RDS, VPC, SUBNET, SG, IAM_ROLE, etc.
  arn           String?  // AWS ARN (null for pending resources)
  awsId         String?  // AWS resource ID (i-xxx, sg-xxx, etc.)
  name          String
  region        String
  
  // Status tracking
  status        String   @default("PENDING") // PENDING, CREATING, ACTIVE, UPDATING, DELETING, DELETED, FAILED
  
  // Configuration (service-specific JSON)
  config        String   // JSON: instance type, storage, etc.
  
  // Cost tracking
  monthlyCost   Float    @default(0)
  lastCostSync  DateTime?
  
  // Metadata
  tags          String?  // JSON: { "Environment": "prod", "Team": "backend" }
  
  // Architecture relationship
  architectureId String?
  architecture   Architecture? @relation(fields: [architectureId], references: [id], onDelete: SetNull)
  
  // Audit
  createdBy     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([tenantId, arn])
  @@index([tenantId])
  @@index([type])
  @@index([status])
  @@index([architectureId])
}

// Architecture - Visual infrastructure designs
model Architecture {
  id            String   @id @default(cuid())
  tenantId      String
  userId        String
  
  // Basic info
  name          String
  description   String?
  version       Int      @default(1)
  
  // Visual canvas state (React Flow JSON)
  nodes         String   // JSON: React Flow nodes
  edges         String   // JSON: React Flow edges
  viewport      String?  // JSON: viewport state
  
  // Resource definitions
  resources     String?  // JSON: array of resource configs
  
  // Deployment status
  status        String   @default("draft") // draft, active, deploying, deployed, failed, archived
  deployedAt    DateTime?
  deployError   String?
  
  // Cost estimation
  estimatedCost Float    @default(0)
  
  // Sharing
  isShared      Boolean  @default(false)
  
  // Generated outputs
  terraformCode String?  // Generated Terraform HCL
  iamPolicies   String?  // JSON: generated IAM policies
  
  // Audit
  createdBy     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  cloudResources CloudResource[]
  deployments    ArchitectureDeployment[]
  
  @@index([tenantId])
  @@index([userId])
  @@index([status])
}

// Architecture Deployment History
model ArchitectureDeployment {
  id              String   @id @default(cuid())
  architectureId  String
  architecture    Architecture @relation(fields: [architectureId], references: [id], onDelete: Cascade)
  
  // Deployment info
  version         Int
  status          String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, FAILED, ROLLED_BACK
  
  // Changes made
  resourcesCreated Int     @default(0)
  resourcesUpdated Int     @default(0)
  resourcesDeleted Int     @default(0)
  
  // Logs
  logs            String?  // JSON: array of log entries
  error           String?
  
  // Timing
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime @default(now())
  
  @@index([architectureId])
}

// Alert Rules - Monitoring alerts
model AlertRule {
  id          String   @id @default(cuid())
  tenantId    String
  
  // Alert definition
  name        String
  description String?
  
  // Condition
  metric      String   // CPU, MEMORY, COST, ERROR_RATE, etc.
  resourceType String? // EC2, LAMBDA, etc. (null = all)
  resourceId  String?  // Specific resource (null = all of type)
  operator    String   // GT, LT, EQ, GTE, LTE
  threshold   Float
  duration    Int      @default(300) // seconds to sustain before alerting
  
  // Notification
  channels    String   // JSON: ["email", "slack", "webhook"]
  channelConfig String // JSON: { "slack": "webhook_url", "email": ["a@b.com"] }
  
  // State
  enabled     Boolean  @default(true)
  lastTriggered DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  incidents   AlertIncident[]
  
  @@index([tenantId])
  @@index([enabled])
}

// ============================================
// CloudFlow - Visual Workflow Automation
// ============================================

// CloudFlow Flow Definition
model CloudFlow {
  id          String   @id @default(cuid())
  tenantId    String
  
  // Owner - user who created/owns this flow
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Basic info
  name        String
  description String?
  
  // Flow definition (React Flow JSON)
  nodes       String   // JSON: array of FlowNode
  edges       String   // JSON: array of FlowEdge
  viewport    String?  // JSON: { x, y, zoom } for canvas position
  
  // Trigger configuration
  triggerType String   @default("manual") // manual, cron, webhook
  triggerConfig String? // JSON: cron expression, webhook config
  
  // State
  status      String   @default("draft") // draft, active, paused
  isShared    Boolean  @default(false)   // visible to all tenant users
  
  // Versioning
  version     Int      @default(1)
  
  // Execution stats
  lastRunAt   DateTime?
  lastRunStatus String? // success, error
  runCount    Int      @default(0)
  
  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  executions  FlowExecution[]
  secrets     FlowSecret[]
  
  @@index([tenantId])
  @@index([userId])
  @@index([status])
}

// Flow-specific secret references (which tenant secrets a flow uses)
model FlowSecret {
  id          String   @id @default(cuid())
  flowId      String
  flow        CloudFlow @relation(fields: [flowId], references: [id], onDelete: Cascade)
  
  // Reference to tenant secret by key (not the actual value)
  secretKey   String   // e.g., "AWS_ACCESS_KEY", "SLACK_WEBHOOK"
  
  // Which node uses this secret
  nodeId      String?  // Optional: specific node that uses this secret
  configField String?  // Optional: which config field uses this secret
  
  createdAt   DateTime @default(now())
  
  @@unique([flowId, secretKey, nodeId])
  @@index([flowId])
}

// CloudFlow Execution History
model FlowExecution {
  id          String   @id @default(cuid())
  flowId      String
  flow        CloudFlow @relation(fields: [flowId], references: [id], onDelete: Cascade)
  tenantId    String
  
  // Execution info
  status      String   @default("pending") // pending, running, success, error, cancelled
  triggeredBy String   // manual, cron, webhook, api
  
  // Results
  results     String?  // JSON: node execution results
  logs        String?  // JSON: execution logs
  error       String?
  
  // Timing
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime @default(now())
  
  @@index([flowId])
  @@index([tenantId])
  @@index([status])
}

// Alert Incidents - Triggered alerts
model AlertIncident {
  id          String   @id @default(cuid())
  alertRuleId String
  alertRule   AlertRule @relation(fields: [alertRuleId], references: [id], onDelete: Cascade)
  
  // Incident info
  status      String   @default("OPEN") // OPEN, ACKNOWLEDGED, RESOLVED
  severity    String   @default("WARNING") // INFO, WARNING, CRITICAL
  
  // Details
  value       Float    // The value that triggered the alert
  message     String
  resourceArn String?
  
  // Resolution
  acknowledgedBy String?
  acknowledgedAt DateTime?
  resolvedAt    DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([alertRuleId])
  @@index([status])
}

// Email verification tokens
model VerificationToken {
  id        String   @id @default(cuid())
  token     String   @unique
  email     String
  expires   DateTime
  createdAt DateTime @default(now())
  
  @@index([token])
  @@index([email])
}

// Desktop Agent scan results
model AgentScan {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  scanPath  String
  fileCount Int
  folderCount Int
  totalSize BigInt
  fileTypes Json     // { "pdf": 10, "docx": 5, ... }
  largeFiles Json    // [{ name, path, size }, ...]
  
  createdAt DateTime @default(now())
  
  @@index([tenantId])
}

// Agent Commands - queued commands for the agent to execute
model AgentCommand {
  id        String   @id @default(cuid())
  tenantId  String
  
  type      String   // SCAN, LIST, DISCOVER, UPLOAD, DOWNLOAD
  payload   String   // JSON payload with command parameters
  status    String   @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED
  result    String?  // JSON result from execution
  error     String?  // Error message if failed
  
  createdAt   DateTime @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  
  @@index([tenantId])
  @@index([status])
}

// ============================================
// CloudMigrate - Infrastructure Discovery
// ============================================

// Discovery Scan - records each network scan
model DiscoveryScan {
  id          String   @id @default(cuid())
  tenantId    String
  
  scanId      String   // Agent-generated scan ID
  networkCidr String   // e.g., "192.168.1.0/24"
  startedAt   DateTime
  completedAt DateTime
  hostsFound  Int      @default(0)
  summary     String   // JSON: { byCategory, byOs, etc. }
  
  createdAt   DateTime @default(now())
  
  hosts       DiscoveredHost[]
  
  @@index([tenantId])
  @@index([completedAt])
}

// Discovered Host - individual servers/devices found
model DiscoveredHost {
  id            String   @id @default(cuid())
  tenantId      String
  
  // Network info
  ip            String
  hostname      String?
  mac           String?
  status        String   @default("online") // online, offline
  
  // System info
  os            String?  // Windows, Linux, etc.
  osVersion     String?
  
  // Classification
  category      String   // compute, database, storage, networking, identity, etc.
  awsTarget     String?  // Recommended AWS service
  
  // Detected services
  openPorts     String   // JSON array of PortInfo
  services      String   // JSON array of ServiceInfo
  
  // Performance
  responseTimeMs Int     @default(0)
  
  // Metadata
  metadata      String?  // JSON for extra info
  lastSeen      DateTime @default(now())
  
  // Migration status
  migrationStatus String @default("discovered") // discovered, assessed, ready, migrating, migrated
  migrationNotes  String?
  
  // Relations
  scanId        String?
  scan          DiscoveryScan? @relation(fields: [scanId], references: [id], onDelete: SetNull)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([tenantId, ip])
  @@index([tenantId])
  @@index([category])
  @@index([status])
  @@index([migrationStatus])
}

// Migration Workload - grouped assets for migration
model MigrationWorkload {
  id          String   @id @default(cuid())
  tenantId    String
  
  name        String
  description String?
  category    String   // compute, database, storage, etc.
  
  // Source info
  sourceType  String   // vm, database, file-share, etc.
  sourceConfig String  // JSON: source-specific config
  
  // Target info
  awsService  String   // EC2, RDS, S3, etc.
  targetConfig String  // JSON: AWS-specific config
  
  // Status
  status      String   @default("pending") // pending, ready, migrating, completed, failed
  progress    Int      @default(0)
  
  // Cost estimation
  estimatedCost Float  @default(0)
  
  // Timing
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  
  // Logs
  logs        String?  // JSON array of log entries
  error       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
  @@index([status])
  @@index([category])
}

// ============================================
// Crawl4AI RAG Tables (managed by crawl4ai service)
// These are defined here to prevent Prisma from dropping them
// ============================================

model sources {
  source_id        String   @id
  tenant_id        String
  user_id          String   @default("default")
  summary          String?
  total_word_count Int      @default(0)
  created_at       DateTime @default(now())
  updated_at       DateTime @default(now())
  
  crawled_pages    crawled_pages[]
  code_examples    code_examples[]
  
  @@map("sources")
}

model crawled_pages {
  id           BigInt   @id @default(autoincrement())
  url          String
  chunk_number Int
  content      String
  metadata     Json     @default("{}")
  source_id    String
  tenant_id    String
  user_id      String   @default("default")
  embedding    Unsupported("vector(1536)")?
  created_at   DateTime @default(now())
  
  source       sources  @relation(fields: [source_id], references: [source_id])
  
  @@unique([url, chunk_number])
  @@index([source_id])
  @@index([tenant_id])
  @@index([user_id])
  @@map("crawled_pages")
}

model code_examples {
  id           BigInt   @id @default(autoincrement())
  url          String
  chunk_number Int
  content      String
  summary      String
  metadata     Json     @default("{}")
  source_id    String
  tenant_id    String
  user_id      String   @default("default")
  embedding    Unsupported("vector(1536)")?
  created_at   DateTime @default(now())
  
  source       sources  @relation(fields: [source_id], references: [source_id])
  
  @@unique([url, chunk_number])
  @@index([source_id])
  @@index([tenant_id])
  @@map("code_examples")
}

model reports {
  id              BigInt   @id @default(autoincrement())
  report_id       String   @unique
  source_id       String
  tenant_id       String?
  title           String
  report_content  String
  report_summary  String?
  focus_query     String?
  chunks_analyzed Int?
  model_used      String?
  metadata        Json     @default("{}")
  embedding       Unsupported("vector(1536)")?
  created_at      DateTime @default(now())
  
  @@index([source_id])
  @@index([tenant_id])
  @@map("reports")
}

// ============================================
// CloudAcademy - Learning & Challenge Platform
// ============================================

// Academy-specific Tenant (separate from main CloudMigrate Tenant)
model AcademyTenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  plan      String   @default("FREE") // FREE, LEARNER, PRO, TEAM
  
  // Stripe
  stripeCustomerId  String?
  stripeSubId       String?
  
  // AI Integration (BYOK)
  openaiApiKey      String?
  preferredModel    String?  @default("gpt-4.1")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  users     AcademyUser[]
  teams     AcademyTeam[]
  profiles  AcademyUserProfile[]
  activities AcademyActivity[]
  scenarioAttempts ScenarioAttempt[]
  teamChallengeAttempts TeamChallengeAttempt[]
  customLocations CustomLocation[]
  customScenarios CustomScenario[]
  customScenarioAttempts CustomScenarioAttempt[]
}

// Academy-specific User (separate from main CloudMigrate User)
model AcademyUser {
  id            String    @id @default(cuid())
  email         String    @unique
  username      String?   @unique  // Optional unique username for display
  name          String?
  passwordHash  String
  role          String    @default("USER") // ADMIN, USER
  emailVerified DateTime?
  
  tenantId      String
  tenant        AcademyTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  profile       AcademyUserProfile?
  teamMembers   AcademyTeamMember[]
  teamInvites   AcademyTeamInvite[]
  teamActivities TeamActivity[]
  
  // Versus matches
  versusAsPlayer1  VersusMatch[] @relation("VersusPlayer1")
  versusAsPlayer2  VersusMatch[] @relation("VersusPlayer2")
  h2hAsPlayer1     HeadToHeadRecord[] @relation("H2HPlayer1")
  h2hAsPlayer2     HeadToHeadRecord[] @relation("H2HPlayer2")
  
  // Gaming
  gameProfile      GameProfile?
  gameMatches1     GameMatch[] @relation("GameMatchPlayer1")
  gameMatches2     GameMatch[] @relation("GameMatchPlayer2")
  matchmakingQueue MatchmakingQueue?
  gameAchievements GameAchievementUnlock[]
  
  @@index([tenantId])
}

// Team for collaborative challenges
model AcademyTeam {
  id          String   @id @default(cuid())
  tenantId    String?  // Legacy - to be removed
  
  // New: Reference to AcademyTenant
  academyTenantId String?
  academyTenant   AcademyTenant? @relation(fields: [academyTenantId], references: [id], onDelete: Cascade)
  
  name        String
  slug        String   // URL-friendly name
  description String?
  avatarUrl   String?
  
  // Team settings
  visibility  String   @default("private")  // private, tenant, public
  maxMembers  Int      @default(10)
  
  // Gamification
  totalPoints Int      @default(0)
  level       Int      @default(1)
  
  // Metadata
  settings    Json     @default("{}")  // Future extensibility
  
  createdBy   String   // userId who created
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  members     AcademyTeamMember[]
  attempts    TeamChallengeAttempt[]
  invites     AcademyTeamInvite[]
  activities  TeamActivity[]
  
  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([academyTenantId])
  @@index([visibility])
}

model AcademyTeamMember {
  id        String   @id @default(cuid())
  teamId    String
  team      AcademyTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId    String?  // Legacy - to be removed
  
  // New: Reference to AcademyUser
  academyUserId String?
  academyUser   AcademyUser? @relation(fields: [academyUserId], references: [id], onDelete: Cascade)
  
  role      String   @default("member")  // owner, admin, member
  
  // Member stats within team
  pointsContributed Int @default(0)
  challengesCompleted Int @default(0)
  
  joinedAt  DateTime @default(now())
  
  @@unique([teamId, userId])
  @@unique([teamId, academyUserId])  // Prevent duplicate memberships
  @@index([userId])
  @@index([academyUserId])
}

model AcademyTeamInvite {
  id        String   @id @default(cuid())
  teamId    String
  team      AcademyTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  email     String?  // Email invite
  userId    String?  // Legacy - to be removed
  
  // New: Reference to AcademyUser
  academyUserId String?
  academyUser   AcademyUser? @relation(fields: [academyUserId], references: [id], onDelete: SetNull)
  code      String   @unique  // Invite code for link sharing
  
  role      String   @default("member")  // Role when accepted
  expiresAt DateTime
  usedAt    DateTime?
  usedBy    String?  // userId who used the invite
  
  createdBy String
  createdAt DateTime @default(now())
  
  @@index([teamId])
  @@index([code])
  @@index([email])
  @@index([academyUserId])
}

// Team Activity Feed - tracks team-level events for feeds and analytics
model TeamActivity {
  id          String   @id @default(cuid())
  teamId      String
  team        AcademyTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  // Who performed the action
  academyUserId String?
  academyUser   AcademyUser? @relation(fields: [academyUserId], references: [id], onDelete: SetNull)
  
  // Activity type: challenge_completed, scenario_started, member_joined, badge_earned, level_up, etc.
  activityType  String
  
  // Points earned from this activity (if applicable)
  pointsEarned  Int @default(0)
  
  // Flexible metadata for different activity types
  // e.g., { challengeId, challengeTitle, score } or { badgeId, badgeName }
  metadata      Json @default("{}")
  
  // Display text (pre-computed for feed display)
  title         String    // "Ju completed S3 Security Challenge"
  description   String?   // Optional longer description
  
  createdAt     DateTime @default(now())
  
  @@index([teamId])
  @@index([academyUserId])
  @@index([activityType])
  @@index([createdAt])
}

// Versus Match - Head-to-head battles
model VersusMatch {
  id            String   @id @default(cuid())
  matchCode     String   @unique
  
  // Players
  player1Id     String
  player1       AcademyUser @relation("VersusPlayer1", fields: [player1Id], references: [id], onDelete: Cascade)
  player2Id     String
  player2       AcademyUser @relation("VersusPlayer2", fields: [player2Id], references: [id], onDelete: Cascade)
  
  // Challenge (optional)
  challengeId   String?
  challenge     AcademyChallenge? @relation(fields: [challengeId], references: [id], onDelete: SetNull)
  
  // Match config
  matchType     String   @default("quiz")  // quiz, diagram
  status        String   @default("pending")  // pending, active, completed, cancelled
  
  // Scores
  player1Score  Int      @default(0)
  player2Score  Int      @default(0)
  winnerId      String?
  
  // Quiz state
  currentQuestion Int    @default(0)
  totalQuestions  Int    @default(10)
  
  // Match state (questions, answers, buzzes)
  matchState    Json     @default("{}")
  
  // Chat messages
  chatMessages  Json     @default("[]")
  
  // Timestamps
  createdAt     DateTime @default(now())
  startedAt     DateTime?
  completedAt   DateTime?
  
  @@index([player1Id])
  @@index([player2Id])
  @@index([status])
  @@index([matchCode])
}

// Head to Head Record - Track win/loss between two players
model HeadToHeadRecord {
  id            String   @id @default(cuid())
  
  player1Id     String
  player1       AcademyUser @relation("H2HPlayer1", fields: [player1Id], references: [id], onDelete: Cascade)
  player2Id     String
  player2       AcademyUser @relation("H2HPlayer2", fields: [player2Id], references: [id], onDelete: Cascade)
  
  player1Wins   Int      @default(0)
  player2Wins   Int      @default(0)
  draws         Int      @default(0)
  totalMatches  Int      @default(0)
  
  lastMatchAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([player1Id, player2Id])
  @@index([player1Id])
  @@index([player2Id])
}

// Location/Company definitions (replaces hardcoded LOCATIONS)
model AcademyLocation {
  id          String   @id @default(cuid())
  
  // Location identity
  slug        String   @unique  // "hsbc-london", "amazon-seattle"
  name        String            // "HSBC Tower"
  company     String            // "HSBC"
  industry    String            // "Banking & Finance"
  
  // Geolocation
  lat         Float
  lng         Float
  region      String?           // "EMEA", "APAC", "Americas"
  country     String?
  city        String?
  
  // Display
  icon        String   @default("üè¢")
  imageUrl    String?
  
  // Challenge metadata
  difficulty  String   @default("intermediate")  // beginner, intermediate, advanced, expert
  description String   @db.Text
  
  // Compliance/tags as JSON for flexibility
  compliance  Json     @default("[]")  // ["PCI-DSS", "GDPR", "HIPAA"]
  tags        Json     @default("[]")  // ["finance", "global", "high-availability"]
  
  // Unlock mechanics
  isLocked    Boolean  @default(false)
  unlockRequirements Json @default("[]")  // [{ "type": "location", "id": "...", "challenges": 3 }]
  
  // Stats (denormalized for performance)
  totalAttempts   Int @default(0)
  avgCompletionRate Float @default(0)
  
  // Lifecycle
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  scenarios   AcademyScenario[]
  progress    UserLocationProgress[]
  
  @@index([industry])
  @@index([difficulty])
  @@index([region])
  @@index([isActive])
}

// Generated scenarios (cached from Learning Agent)
model AcademyScenario {
  id            String   @id @default(cuid())
  locationId    String
  location      AcademyLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
  
  // Scenario identity
  title         String
  description   String   @db.Text
  businessContext String @db.Text
  difficulty    String
  
  // Requirements as JSON for flexibility
  technicalRequirements Json @default("[]")
  complianceRequirements Json @default("[]")
  constraints   Json     @default("[]")
  learningObjectives Json @default("[]")
  tags          Json     @default("[]")
  
  // Time & effort
  estimatedMinutes Int @default(60)
  maxPoints     Int      @default(1000)
  
  // Versioning & targeting
  version       Int      @default(1)
  targetLevel   String   @default("intermediate")  // Who this scenario is for
  
  // Company research cache (from Learning Agent)
  companyInfo   Json?    // Cached CompanyInfo from research
  
  // Lifecycle
  isActive      Boolean  @default(true)
  generatedBy   String?  // "learning_agent_v1", "manual", etc.
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  challenges    AcademyChallenge[]
  attempts      ScenarioAttempt[]
  teamAttempts  TeamChallengeAttempt[]
  
  // Learning mode content
  flashcardDecks FlashcardDeck[]
  studyNotes    StudyNotes[]
  coachingSessions CoachingSession[]
  quizzes       Quiz[]
  
  @@index([locationId])
  @@index([isActive])
  @@index([targetLevel])
  @@index([difficulty])
}

// Individual challenges within a scenario
model AcademyChallenge {
  id            String   @id @default(cuid())
  scenarioId    String
  scenario      AcademyScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  
  // Challenge identity
  title         String
  description   String   @db.Text
  difficulty    String
  orderIndex    Int      @default(0)
  
  // Scoring
  points        Int      @default(100)
  bonusPoints   Int      @default(0)  // For completing without hints, under time, etc.
  
  // Content as JSON for flexibility
  hints         Json     @default("[]")
  successCriteria Json   @default("[]")
  awsServices   Json     @default("[]")
  
  // Optional: structured solution template
  solutionTemplate Json? // Expected architecture components
  evaluationRubric Json? // How to score solutions
  
  // Time
  estimatedMinutes Int @default(15)
  timeLimitMinutes Int? // Optional hard limit
  
  // Dependencies
  prerequisiteChallengeIds Json @default("[]")  // Must complete these first
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  progress      ChallengeProgress[]
  versusMatches VersusMatch[]
  
  @@index([scenarioId])
  @@index([orderIndex])
}

// User's profile/preferences for Academy
model AcademyUserProfile {
  id          String   @id @default(cuid())
  userId      String?  @unique
  tenantId    String?
  
  // Reference to AcademyUser and AcademyTenant
  academyUserId   String?  @unique
  academyUser     AcademyUser? @relation(fields: [academyUserId], references: [id], onDelete: Cascade)
  academyTenantId String?
  academyTenant   AcademyTenant? @relation(fields: [academyTenantId], references: [id], onDelete: Cascade)
  
  // Subscription tier: free, learner, pro, team
  // free    = browse only, no AI, no Neo4j
  // learner = AI coaching, challenges, flashcards ($19/mo)
  // pro     = AI + Neo4j knowledge graph, custom scenarios ($49/mo)
  // team    = full access, team features, admin ($29/user/mo)
  subscriptionTier String @default("free")
  subscriptionExpiresAt DateTime?
  
  // Feature flags based on tier
  hasAiAccess Boolean @default(false)
  hasNeo4jAccess Boolean @default(false)
  hasTeamAccess Boolean @default(false)
  
  // Usage tracking
  challengesStartedThisMonth Int @default(0)
  aiRequestsThisMonth Int @default(0)
  usageResetAt DateTime @default(now())
  
  // Display
  displayName String?
  avatarUrl   String?
  bio         String?
  
  // Skill level & preferences
  skillLevel  String   @default("intermediate")
  targetCertification String?  // AWS certification goal: SAA, SAP, DVA, SOA, DOP, ANS, SCS, DBS, MLS, PAS, CLF
  preferredIndustries Json @default("[]")
  preferredDifficulty String?
  
  // Gamification
  totalPoints Int      @default(0)
  level       Int      @default(1)
  xp          Int      @default(0)  // XP within current level
  
  // Streaks
  currentStreak Int    @default(0)
  longestStreak Int    @default(0)
  lastActivityDate DateTime?
  
  // Achievements/badges as JSON
  achievements Json    @default("[]")  // [{ "id": "first_challenge", "earnedAt": "..." }]
  
  // Stats
  challengesCompleted Int @default(0)
  scenariosCompleted Int @default(0)
  locationsVisited Int @default(0)
  totalTimeMinutes Int @default(0)

  // Preferences
  settings    Json     @default("{}")  // UI preferences, notifications, etc.

  studyPlans  StudyPlan[]

  // BYOK - Bring Your Own Key (encrypted)
  // Format: iv:authTag:encryptedData (same as Secret model)
  openaiApiKey      String?  // Encrypted OpenAI API key
  openaiKeyLastFour String?  // Last 4 chars for display (e.g., "sk-...a1b2")
  openaiKeyAddedAt  DateTime?
  preferredModel    String?  @default("gpt-4.1") // User's preferred GPT model
  
  // AWS Credentials (encrypted) - for diagram deployment
  // Users can deploy their diagrams to real AWS infrastructure
  awsAccessKeyId      String?  // Encrypted AWS Access Key ID
  awsSecretAccessKey  String?  // Encrypted AWS Secret Access Key
  awsRegion           String?  @default("us-east-1")
  awsKeyLastFour      String?  // Last 4 chars of Access Key ID for display
  awsKeyAddedAt       DateTime?
  awsCredentialsValid Boolean  @default(false)  // Last validation result
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  locationProgress UserLocationProgress[]
  scenarioAttempts ScenarioAttempt[]
  portfolios       AcademyPortfolio[]
  
  // Learning mode relations
  flashcardDecks    FlashcardDeck[]  // Certification-based decks owned by user
  flashcardProgress FlashcardUserProgress[]
  studyNotesProgress StudyNotesProgress[]
  coachingSessions CoachingSession[]
  quizAttempts QuizAttempt[]
  customLocations CustomLocation[]
  
  // CLI proficiency tracking
  cliProficiency CLIProficiency?
  
  // Practice Exams
  examAttempts     ExamAttempt[]
  
  // Learning Centre Chat
  learningChats    LearningChat[]
  
  // External Resources (YouTube, docs, user-added)
  externalResources ExternalResource[]
  
  @@index([academyUserId])
  @@index([academyTenantId])
  @@index([totalPoints])
  @@index([level])
}

// Learning Centre Chat - Persistent chat history for AI tutor
model LearningChat {
  id          String   @id @default(cuid())
  
  profileId   String
  profile     AcademyUserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Chat session info
  title       String   @default("New Chat")  // Auto-generated from first message
  
  // Messages stored as JSON array for simplicity
  // [{ id, role, content, timestamp, keywords? }]
  messages    Json     @default("[]")
  
  // Extracted keywords from this chat (for agent context)
  keywords    Json     @default("[]")  // ["VPC", "Lambda", "S3"]
  
  // Analytics for agent to understand user struggles
  topicsDiscussed Json @default("[]")  // Categories discussed
  questionsAsked  Int  @default(0)
  
  // Timestamps
  lastMessageAt DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([profileId])
  @@index([lastMessageAt])
}

// Portfolio - Generated PDF showcasing completed challenges
model AcademyPortfolio {
  id          String   @id @default(cuid())
  
  // Owner (null for example portfolios that all users see)
  profileId   String?
  profile     AcademyUserProfile? @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Portfolio identity
  title       String
  description String?  @db.Text
  
  // Status: draft, generating, ready, failed
  status      String   @default("draft")
  
  // Type: example (system-provided), generated (from challenges)
  type        String   @default("generated")
  isExample   Boolean  @default(false)  // Example portfolios shown to all users
  
  // Content - The actual portfolio data
  businessUseCase     String?  @db.Text  // Business context from scenario
  problemStatement    String?  @db.Text  // What needed to be solved
  solutionSummary     String?  @db.Text  // AI-generated summary of solution
  awsServices         Json     @default("[]")  // AWS services used
  architectureDiagram Json?    // {nodes, edges} from React Flow
  diagramSvg          String?  @db.Text  // Pre-rendered SVG for PDF
  keyDecisions        Json     @default("[]")  // Architectural decisions
  complianceAchieved  Json     @default("[]")  // Compliance standards met
  
  // Scoring/Stats from the challenge
  challengeScore      Int      @default(0)
  maxScore            Int      @default(0)
  completionTimeMinutes Int    @default(0)
  hintsUsed           Int      @default(0)
  
  // Source references - which challenge this came from
  scenarioAttemptId   String?
  challengeProgressId String?
  locationSlug        String?  // Which location/company
  locationName        String?  // Denormalized for display
  companyName         String?  // Denormalized for display
  industry            String?  // Denormalized for display
  
  // PDF Generation
  pdfUrl              String?  // URL to generated PDF
  thumbnailUrl        String?  // URL to thumbnail for display
  generatedAt         DateTime?
  generationError     String?
  
  // Sharing
  isPublic            Boolean  @default(false)
  shareCode           String?  @unique  // Unique code for sharing
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([profileId])
  @@index([status])
  @@index([type])
  @@index([isExample])
  @@index([isPublic])
}

// User progress on a location (high-level)
model UserLocationProgress {
  id          String   @id @default(cuid())
  
  profileId   String
  profile     AcademyUserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  locationId  String
  location    AcademyLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
  
  // Progress
  status      String   @default("not_started")  // not_started, visited, in_progress, completed
  
  // Timestamps
  firstVisitedAt DateTime @default(now())
  lastVisitedAt DateTime @default(now())
  completedAt DateTime?
  
  // Aggregated stats
  totalPoints Int      @default(0)
  challengesCompleted Int @default(0)
  totalChallenges Int  @default(0)
  timeSpentMinutes Int @default(0)
  
  // Best attempt reference
  bestAttemptId String?
  
  @@unique([profileId, locationId])
  @@index([profileId])
  @@index([locationId])
  @@index([status])
}

// Scenario attempt (a user's session with a scenario)
model ScenarioAttempt {
  id          String   @id @default(cuid())
  
  profileId   String
  profile     AcademyUserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  scenarioId  String
  scenario    AcademyScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  
  tenantId    String?  // Legacy - to be removed
  
  // New: Reference to AcademyTenant
  academyTenantId String?
  academyTenant   AcademyTenant? @relation(fields: [academyTenantId], references: [id], onDelete: Cascade)
  
  // Team context (optional - for team challenges)
  teamAttemptId String?
  
  // Status
  status      String   @default("in_progress")  // in_progress, completed, abandoned, timed_out
  
  // Timestamps
  startedAt   DateTime @default(now())
  lastActivityAt DateTime @default(now())
  completedAt DateTime?
  
  // Scoring
  pointsEarned Int     @default(0)
  maxPoints   Int      @default(0)
  bonusPoints Int      @default(0)
  
  // Time tracking
  activeTimeMinutes Int @default(0)  // Actual active time (not idle)
  
  // Chat history with coach
  chatHistory Json     @default("[]")  // [{ role, content, timestamp }]
  
  // Metadata
  metadata    Json     @default("{}")  // Browser, device, etc.
  
  challengeProgress ChallengeProgress[]
  
  @@index([profileId])
  @@index([scenarioId])
  @@index([tenantId])
  @@index([academyTenantId])
  @@index([status])
  @@index([startedAt])
}

// Progress on individual challenges
model ChallengeProgress {
  id            String   @id @default(cuid())
  
  attemptId     String
  attempt       ScenarioAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  
  challengeId   String
  challenge     AcademyChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  
  // Status
  status        String   @default("locked")  // locked, available, in_progress, completed, skipped
  
  // Timestamps
  unlockedAt    DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  
  // Scoring
  pointsEarned  Int      @default(0)
  bonusEarned   Int      @default(0)
  hintsUsed     Int      @default(0)
  attemptsCount Int      @default(0)
  
  // Time
  timeSpentMinutes Int   @default(0)
  
  // User's solution
  solution      Json?    // Architecture diagram, answers, etc.
  solutionNotes String?  @db.Text  // User's notes/explanation
  
  // AI evaluation
  feedback      Json?    // { score, strengths, improvements, suggestions }
  evaluatedAt   DateTime?
  
  // CLI practice progress
  cliProgress   CLIProgress?
  
  // Diagram audit tips
  diagramAuditTips DiagramAuditTip[]
  
  @@unique([attemptId, challengeId])
  @@index([challengeId])
  @@index([status])
}

// CLI Practice Progress - tracks user's command-line learning
model CLIProgress {
  id              String   @id @default(cuid())
  
  // Link to challenge progress
  challengeProgressId String @unique
  challengeProgress   ChallengeProgress @relation(fields: [challengeProgressId], references: [id], onDelete: Cascade)
  
  // Session tracking
  sessionId       String?  // Current CLI session ID
  
  // Commands executed
  commandsRun     Json     @default("[]")  // [{ command, timestamp, exitCode, isCorrect }]
  totalCommands   Int      @default(0)
  correctCommands Int      @default(0)
  syntaxErrors    Int      @default(0)
  
  // Simulated resources created
  resourcesCreated Json    @default("{}")  // { "vpc": ["vpc-123"], "ec2": ["i-456"] }
  
  // Challenge-specific validation
  objectivesCompleted Json @default("[]")  // ["created_vpc", "configured_security_group"]
  objectivesTotal     Int  @default(0)
  
  // Scoring
  cliScore        Int      @default(0)     // 0-100 based on correct commands
  pointsEarned    Int      @default(0)     // Points for CLI portion
  
  // Learning metrics
  hintsRequested  Int      @default(0)
  helpTopicsViewed Json    @default("[]")  // ["ec2", "vpc", "s3"]
  
  // Streaks
  currentStreak   Int      @default(0)     // Consecutive correct commands
  bestStreak      Int      @default(0)     // Best streak this session
  
  // Timing
  startedAt       DateTime @default(now())
  lastCommandAt   DateTime?
  completedAt     DateTime?
  
  @@index([challengeProgressId])
}

// User's overall CLI proficiency (aggregated across all challenges)
model CLIProficiency {
  id              String   @id @default(cuid())
  
  profileId       String   @unique
  profile         AcademyUserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Overall stats
  totalCommands   Int      @default(0)
  correctCommands Int      @default(0)
  accuracy        Float    @default(0)     // correctCommands / totalCommands
  
  // Service-specific proficiency
  serviceStats    Json     @default("{}")  // { "ec2": { commands: 50, correct: 45 }, "s3": {...} }
  
  // Achievements
  commandsMastered Json    @default("[]")  // ["aws ec2 describe-instances", "aws s3 ls"]
  
  // Streaks
  currentDailyStreak Int   @default(0)     // Days in a row with CLI practice
  bestDailyStreak    Int   @default(0)
  lastPracticeDate   DateTime?
  
  // Level progression
  cliLevel        Int      @default(1)     // 1-10 CLI mastery level
  cliXp           Int      @default(0)     // XP towards next level
  
  // Badges earned
  badges          Json     @default("[]")  // ["first_command", "vpc_master", "100_commands"]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([profileId])
}

// Team challenge attempts (for team competitions)
model TeamChallengeAttempt {
  id          String   @id @default(cuid())
  
  teamId      String
  team        AcademyTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  scenarioId  String
  scenario    AcademyScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  
  tenantId    String?  // Legacy - to be removed
  
  // New: Reference to AcademyTenant
  academyTenantId String?
  academyTenant   AcademyTenant? @relation(fields: [academyTenantId], references: [id], onDelete: Cascade)
  
  // Status
  status      String   @default("in_progress")  // in_progress, completed, abandoned
  
  // Timestamps
  startedAt   DateTime @default(now())
  completedAt DateTime?
  
  // Scoring
  totalPoints Int      @default(0)
  
  // Member contributions
  contributions Json   @default("{}")  // { "userId": { points, challenges, timeMinutes } }
  
  // Team chat/discussion
  discussion  Json     @default("[]")  // [{ userId, message, timestamp }]
  
  @@unique([teamId, scenarioId])
  @@index([teamId])
  @@index([scenarioId])
  @@index([tenantId])
  @@index([academyTenantId])
  @@index([status])
}

// Leaderboard entries (materialized view pattern - updated periodically)
model AcademyLeaderboard {
  id          String   @id @default(cuid())
  
  // Scope definition
  scope       String   // global, tenant, team, industry
  scopeId     String?  // tenantId, teamId, or industry name
  period      String   // all_time, yearly, monthly, weekly, daily
  periodKey   String   // "2024", "2024-12", "2024-W50", "2024-12-04"
  
  // Entry type
  entryType   String   // user, team
  entryId     String   // profileId or teamId
  
  // Display info (denormalized)
  displayName String
  avatarUrl   String?
  
  // Stats
  totalPoints     Int @default(0)
  challengesCompleted Int @default(0)
  scenariosCompleted Int @default(0)
  locationsCompleted Int @default(0)
  averageScore    Float @default(0)
  
  // Rank
  rank        Int      @default(0)
  previousRank Int?    // For showing movement
  
  // Timestamps
  updatedAt   DateTime @updatedAt
  
  @@unique([scope, scopeId, period, periodKey, entryType, entryId])
  @@index([scope, scopeId, period, periodKey, rank])
  @@index([entryType, entryId])
}

// Achievement definitions
model AcademyAchievement {
  id          String   @id @default(cuid())
  
  // Identity
  slug        String   @unique  // "first_challenge", "speed_demon", "perfect_score"
  name        String
  description String
  
  // Display
  icon        String   // Emoji or icon name
  rarity      String   @default("common")  // common, uncommon, rare, epic, legendary
  
  // Unlock criteria (JSON for flexibility)
  criteria    Json     // { "type": "challenges_completed", "value": 10 }
  
  // Rewards
  pointsReward Int     @default(0)
  xpReward    Int      @default(0)
  
  // Metadata
  category    String   @default("general")  // general, speed, mastery, social, etc.
  isSecret    Boolean  @default(false)  // Hidden until earned
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  
  @@index([category])
  @@index([rarity])
}

// Activity feed for social features
model AcademyActivity {
  id          String   @id @default(cuid())
  
  // Actor
  profileId   String
  tenantId    String?  // Legacy - to be removed
  teamId      String?  // If team-related
  
  // New: Reference to AcademyTenant
  academyTenantId String?
  academyTenant   AcademyTenant? @relation(fields: [academyTenantId], references: [id], onDelete: Cascade)
  
  // Activity type
  type        String   // challenge_completed, scenario_completed, achievement_earned, 
                       // level_up, streak_milestone, team_joined, location_unlocked
  
  // Activity data
  data        Json     // { challengeId, points, achievementId, etc. }
  
  // Visibility
  visibility  String   @default("tenant")  // private, team, tenant, public
  
  createdAt   DateTime @default(now())
  
  @@index([profileId])
  @@index([tenantId])
  @@index([academyTenantId])
  @@index([teamId])
  @@index([type])
  @@index([createdAt])
}

// ============================================
// CloudAcademy - Learning Modes
// Flashcards, Notes, Chat, Quiz
// ============================================

// Flashcard Deck - collection of cards (scenario-based OR certification-based)
model FlashcardDeck {
  id          String   @id @default(cuid())
  
  // Option 1: Scenario-based deck (legacy)
  scenarioId  String?
  scenario    AcademyScenario? @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  
  // Option 2: Certification-based deck (new - uses user telemetry)
  profileId   String?
  profile     AcademyUserProfile? @relation(fields: [profileId], references: [id], onDelete: Cascade)
  certificationCode String?  // SAA, DVA, SOA, etc.
  
  // Deck metadata
  title       String
  description String?
  
  // Generation info
  generatedBy String   @default("ai")  // ai, user, imported
  aiModel     String?  // gpt-4o, etc.
  deckType    String   @default("scenario")  // scenario, certification, custom
  
  // Stats
  totalCards  Int      @default(0)
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  cards       Flashcard[]
  userProgress FlashcardUserProgress[]
  
  @@index([scenarioId])
  @@index([profileId])
  @@index([certificationCode])
}

// Individual Flashcard
model Flashcard {
  id          String   @id @default(cuid())
  
  deckId      String
  deck        FlashcardDeck @relation(fields: [deckId], references: [id], onDelete: Cascade)
  
  // Card content
  front       String   @db.Text  // Question/prompt
  back        String   @db.Text  // Answer/explanation
  
  // Rich content support
  frontType   String   @default("text")  // text, code, image, diagram
  backType    String   @default("text")
  
  // Metadata
  tags        Json     @default("[]")  // ["vpc", "security", "networking"]
  difficulty  String   @default("medium")  // easy, medium, hard
  awsServices Json     @default("[]")  // ["EC2", "VPC", "IAM"]
  
  // Ordering
  orderIndex  Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  userProgress FlashcardProgress[]
  
  @@index([deckId])
  @@index([difficulty])
}

// User's progress on a flashcard deck (spaced repetition)
model FlashcardUserProgress {
  id          String   @id @default(cuid())
  
  profileId   String
  profile     AcademyUserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  deckId      String
  deck        FlashcardDeck @relation(fields: [deckId], references: [id], onDelete: Cascade)
  
  // Overall stats
  cardsStudied    Int @default(0)
  cardsMastered   Int @default(0)  // Cards with high confidence
  totalReviews    Int @default(0)
  
  // Session tracking
  lastStudiedAt   DateTime?
  currentStreak   Int @default(0)  // Days in a row
  
  // Time spent
  totalTimeMinutes Int @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  cardProgress FlashcardProgress[]
  
  @@unique([profileId, deckId])
  @@index([profileId])
  @@index([deckId])
}

// User's progress on individual flashcard (spaced repetition algorithm)
model FlashcardProgress {
  id          String   @id @default(cuid())
  
  userProgressId String
  userProgress   FlashcardUserProgress @relation(fields: [userProgressId], references: [id], onDelete: Cascade)
  
  cardId      String
  card        Flashcard @relation(fields: [cardId], references: [id], onDelete: Cascade)
  
  // Spaced Repetition (SM-2 algorithm style)
  easeFactor  Float    @default(2.5)  // Difficulty multiplier
  interval    Int      @default(1)     // Days until next review
  repetitions Int      @default(0)     // Successful reviews in a row
  
  // Status
  status      String   @default("new")  // new, learning, review, mastered
  
  // Next review
  nextReviewAt DateTime?
  lastReviewAt DateTime?
  
  // History
  totalReviews Int     @default(0)
  correctCount Int     @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userProgressId, cardId])
  @@index([cardId])
  @@index([nextReviewAt])
  @@index([status])
}

// ============================================
// Study Notes
// ============================================

// Personalized study plan generations for Guide tab
model StudyPlan {
  id                 String   @id @default(cuid())
  profileId          String   @map("profile_id")
  targetExam         String?  @map("target_exam")
  examDate           DateTime? @map("exam_date")
  studyHoursPerWeek  Int?     @map("study_hours_per_week")
  confidenceLevel    String?  @map("confidence_level")
  planInputs         Json     @map("plan_inputs")
  planOutput         Json?    @map("plan_output")
  generatedAt        DateTime @default(now()) @map("generated_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  profile            AcademyUserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([generatedAt(sort: Desc)])
  @@map("StudyPlan")
}

// AI-generated or user-created study notes
model StudyNotes {
  id          String   @id @default(cuid())
  
  // Can be scenario-based OR certification-based
  scenarioId  String?
  scenario    AcademyScenario? @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  
  // For certification-based notes (no scenario)
  profileId         String?
  certificationCode String?
  
  // Notes metadata
  title       String
  
  // Content - structured for rich display
  content     String   @db.Text  // Markdown content
  
  // Table of contents / structure
  sections    Json     @default("[]")  // [{ id, title, level, anchor }]
  
  // Generation info
  generatedBy String   @default("ai")  // ai, user
  aiModel     String?
  
  // AWS services covered
  awsServices Json     @default("[]")
  
  // Version control
  version     Int      @default(1)
  
  // Key takeaways
  keyTakeaways Json     @default("[]")
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  userProgress StudyNotesProgress[]
  annotations  StudyAnnotation[]
  
  @@index([scenarioId])
  @@index([profileId])
  @@index([certificationCode])
}

// User's progress/interaction with study notes
model StudyNotesProgress {
  id          String   @id @default(cuid())
  
  profileId   String
  profile     AcademyUserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  notesId     String
  notes       StudyNotes @relation(fields: [notesId], references: [id], onDelete: Cascade)
  
  // Reading progress
  readProgress    Float    @default(0)  // 0-100 percentage
  sectionsRead    Json     @default("[]")  // [sectionId, ...]
  
  // Time tracking
  totalTimeMinutes Int     @default(0)
  lastReadAt      DateTime?
  
  // Bookmarked
  isBookmarked    Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([profileId, notesId])
  @@index([profileId])
  @@index([notesId])
}

// User annotations/highlights on study notes
model StudyAnnotation {
  id          String   @id @default(cuid())
  
  profileId   String
  
  notesId     String
  notes       StudyNotes @relation(fields: [notesId], references: [id], onDelete: Cascade)
  
  // Annotation type
  type        String   // highlight, note, bookmark, question
  
  // Position in content
  sectionId   String?  // Which section
  startOffset Int?     // Character offset start
  endOffset   Int?     // Character offset end
  
  // Content
  selectedText String? @db.Text  // The highlighted text
  userNote    String?  @db.Text  // User's note/comment
  color       String   @default("yellow")  // Highlight color
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([profileId])
  @@index([notesId])
}

// ============================================
// Chat / Coaching Sessions
// ============================================

// Chat session with AI coach for a scenario
model CoachingSession {
  id          String   @id @default(cuid())
  
  profileId   String
  profile     AcademyUserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  scenarioId  String
  scenario    AcademyScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  
  // Session metadata
  title       String   @default("Coaching Session")
  
  // Current context
  currentChallengeId String?  // Which challenge they're working on
  currentMode String?         // flashcard, notes, quiz, general
  
  // Session state
  status      String   @default("active")  // active, completed, archived
  
  // Stats
  messageCount Int     @default(0)
  
  // Time tracking
  startedAt   DateTime @default(now())
  lastMessageAt DateTime?
  endedAt     DateTime?
  
  // Total time
  totalTimeMinutes Int @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  messages    CoachingMessage[]
  
  @@index([profileId])
  @@index([scenarioId])
  @@index([status])
}

// Individual chat message
model CoachingMessage {
  id          String   @id @default(cuid())
  
  sessionId   String
  session     CoachingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // Message content
  role        String   // user, assistant, system
  content     String   @db.Text
  
  // Rich content
  contentType String   @default("text")  // text, code, diagram, suggestion
  
  // Metadata
  metadata    Json     @default("{}")  // { tokensUsed, model, etc. }
  
  // For assistant messages - what triggered it
  triggerType String?  // question, hint_request, feedback, explanation
  
  // Feedback on assistant messages
  helpful     Boolean?
  
  createdAt   DateTime @default(now())
  
  @@index([sessionId])
  @@index([role])
}

// ============================================
// Quizzes
// ============================================

// Quiz - can be scenario-based OR certification-based
model Quiz {
  id          String   @id @default(cuid())
  
  // Can be scenario-based OR certification-based
  scenarioId  String?
  scenario    AcademyScenario? @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  
  // For certification-based quizzes (no scenario)
  profileId         String?
  certificationCode String?
  
  // Quiz metadata
  title       String
  description String?
  
  // Quiz settings
  quizType    String   @default("standard")  // standard, timed, adaptive
  timeLimit   Int?     // Minutes (null = no limit)
  passingScore Int     @default(70)  // Percentage to pass
  
  // Question settings
  questionCount Int    @default(10)
  shuffleQuestions Boolean @default(true)
  shuffleOptions Boolean @default(true)
  showExplanations Boolean @default(true)  // After answering
  
  // Generation info
  generatedBy String   @default("ai")
  aiModel     String?
  
  // Difficulty distribution
  difficultyMix Json   @default("{\"easy\": 30, \"medium\": 50, \"hard\": 20}")
  
  // Stats
  totalAttempts Int    @default(0)
  avgScore      Float  @default(0)
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  questions   QuizQuestion[]
  attempts    QuizAttempt[]
  
  @@index([scenarioId])
  @@index([profileId])
  @@index([certificationCode])
}

// Quiz question
model QuizQuestion {
  id          String   @id @default(cuid())
  
  quizId      String
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  // Question content
  question    String   @db.Text
  questionType String  @default("multiple_choice")  // multiple_choice, multi_select, true_false, free_text, code
  
  // For code questions
  codeLanguage String?  // terraform, python, yaml, json
  codeSnippet String?   @db.Text
  
  // Options (for choice questions)
  options     Json     @default("[]")  // [{ id, text, isCorrect }]
  
  // For free text - expected answer patterns
  expectedAnswer String? @db.Text
  answerPatterns Json   @default("[]")  // Regex patterns for grading
  
  // Explanation shown after answering
  explanation String?  @db.Text
  
  // Metadata
  difficulty  String   @default("medium")
  points      Int      @default(10)
  awsServices Json     @default("[]")
  tags        Json     @default("[]")
  
  // Ordering
  orderIndex  Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  answers     QuizAnswer[]
  
  @@index([quizId])
  @@index([difficulty])
}

// User's quiz attempt
model QuizAttempt {
  id          String   @id @default(cuid())
  
  profileId   String
  profile     AcademyUserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  quizId      String
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  // Attempt status
  status      String   @default("in_progress")  // in_progress, completed, abandoned, timed_out
  
  // Scoring
  score       Float    @default(0)  // Percentage
  pointsEarned Int     @default(0)
  maxPoints   Int      @default(0)
  
  // Question tracking
  questionsAnswered Int @default(0)
  questionsCorrect  Int @default(0)
  totalQuestions    Int @default(0)
  
  // Time tracking
  startedAt   DateTime @default(now())
  completedAt DateTime?
  timeSpentSeconds Int @default(0)
  
  // Pass/fail
  passed      Boolean?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  answers     QuizAnswer[]
  
  @@index([profileId])
  @@index([quizId])
  @@index([status])
}

// User's answer to a quiz question
model QuizAnswer {
  id          String   @id @default(cuid())
  
  attemptId   String
  attempt     QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  
  questionId  String
  question    QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  // User's answer
  selectedOptions Json   @default("[]")  // [optionId, ...] for choice questions
  textAnswer  String?    @db.Text        // For free text questions
  
  // Grading
  isCorrect   Boolean?
  pointsAwarded Int     @default(0)
  
  // AI grading for free text
  aiGradingScore Float?
  aiGradingFeedback String? @db.Text
  
  // Time spent on this question
  timeSpentSeconds Int  @default(0)
  
  answeredAt  DateTime @default(now())
  
  @@unique([attemptId, questionId])
  @@index([attemptId])
  @@index([questionId])
}

// ============================================
// Custom User Locations (Any business on map)
// ============================================

// User-created location (corner shop, any business)
model CustomLocation {
  id          String   @id @default(cuid())
  
  profileId   String
  profile     AcademyUserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  tenantId    String?  // Legacy - to be removed
  
  // New: Reference to AcademyTenant
  academyTenantId String?
  academyTenant   AcademyTenant? @relation(fields: [academyTenantId], references: [id], onDelete: Cascade)
  
  // Location info (from Google Places or user input)
  placeId     String?  // Google Places ID
  name        String
  address     String?
  
  // Geo
  lat         Float
  lng         Float
  
  // Business info (researched by AI)
  businessType String?
  industry    String?
  description String?  @db.Text
  
  // Research results (cached)
  researchData Json?   // Full research from Learning Agent
  researchedAt DateTime?
  
  // Display
  icon        String   @default("üìç")
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  scenarios   CustomScenario[]
  
  @@index([profileId])
  @@index([tenantId])
  @@index([academyTenantId])
  @@index([placeId])
}

// Scenario generated for a custom location
model CustomScenario {
  id          String   @id @default(cuid())
  
  locationId  String
  location    CustomLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
  
  profileId   String
  tenantId    String?  // Legacy - to be removed
  
  // New: Reference to AcademyTenant
  academyTenantId String?
  academyTenant   AcademyTenant? @relation(fields: [academyTenantId], references: [id], onDelete: Cascade)
  
  // Scenario content (same structure as AcademyScenario)
  title       String
  description String   @db.Text
  businessContext String @db.Text
  difficulty  String
  
  // Requirements
  technicalRequirements Json @default("[]")
  complianceRequirements Json @default("[]")
  constraints Json     @default("[]")
  learningObjectives Json @default("[]")
  tags        Json     @default("[]")
  
  // Time & scoring
  estimatedMinutes Int @default(60)
  maxPoints   Int      @default(1000)
  
  // Company research (from Learning Agent)
  companyInfo Json?
  
  // Generation info
  generatedBy String   @default("learning_agent")
  aiModel     String?
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  challenges  CustomChallenge[]
  flashcardDecks CustomFlashcardDeck[]
  studyNotes  CustomStudyNotes[]
  quizzes     CustomQuiz[]
  coachingSessions CustomCoachingSession[]
  attempts    CustomScenarioAttempt[]
  
  @@index([locationId])
  @@index([profileId])
  @@index([tenantId])
  @@index([academyTenantId])
}

// Challenge within a custom scenario
model CustomChallenge {
  id          String   @id @default(cuid())
  
  scenarioId  String
  scenario    CustomScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  
  // Challenge content
  title       String
  description String   @db.Text
  difficulty  String
  orderIndex  Int      @default(0)
  
  // Scoring
  points      Int      @default(100)
  bonusPoints Int      @default(0)
  
  // Content
  hints       Json     @default("[]")
  successCriteria Json @default("[]")
  awsServices Json     @default("[]")
  
  // Time
  estimatedMinutes Int @default(15)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  progress    CustomChallengeProgress[]
  
  @@index([scenarioId])
}

// User's attempt at a custom scenario
model CustomScenarioAttempt {
  id          String   @id @default(cuid())
  
  profileId   String
  scenarioId  String
  scenario    CustomScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  
  tenantId    String?  // Legacy - to be removed
  
  // New: Reference to AcademyTenant
  academyTenantId String?
  academyTenant   AcademyTenant? @relation(fields: [academyTenantId], references: [id], onDelete: Cascade)
  
  // Status
  status      String   @default("in_progress")
  
  // Timestamps
  startedAt   DateTime @default(now())
  lastActivityAt DateTime @default(now())
  completedAt DateTime?
  
  // Scoring
  pointsEarned Int     @default(0)
  maxPoints   Int      @default(0)
  
  // Time
  activeTimeMinutes Int @default(0)
  
  // Learning mode progress
  flashcardsCompleted Boolean @default(false)
  notesCompleted      Boolean @default(false)
  quizCompleted       Boolean @default(false)
  chatUsed            Boolean @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  challengeProgress CustomChallengeProgress[]
  
  @@index([profileId])
  @@index([scenarioId])
  @@index([tenantId])
  @@index([academyTenantId])
}

// Progress on custom challenge
model CustomChallengeProgress {
  id          String   @id @default(cuid())
  
  attemptId   String
  attempt     CustomScenarioAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  
  challengeId String
  challenge   CustomChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  
  // Status
  status      String   @default("locked")
  
  // Timestamps
  startedAt   DateTime?
  completedAt DateTime?
  
  // Scoring
  pointsEarned Int     @default(0)
  hintsUsed   Int      @default(0)
  
  // Time
  timeSpentMinutes Int @default(0)
  
  // Solution
  solution    Json?
  feedback    Json?
  
  @@unique([attemptId, challengeId])
  @@index([challengeId])
}

// ============================================
// Custom Location Learning Content
// (Mirrors the main models but for custom locations)
// ============================================

model CustomFlashcardDeck {
  id          String   @id @default(cuid())
  scenarioId  String
  scenario    CustomScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  generatedBy String   @default("ai")
  totalCards  Int      @default(0)
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  cards       CustomFlashcard[]
  
  @@index([scenarioId])
}

model CustomFlashcard {
  id          String   @id @default(cuid())
  deckId      String
  deck        CustomFlashcardDeck @relation(fields: [deckId], references: [id], onDelete: Cascade)
  
  front       String   @db.Text
  back        String   @db.Text
  frontType   String   @default("text")
  backType    String   @default("text")
  tags        Json     @default("[]")
  difficulty  String   @default("medium")
  awsServices Json     @default("[]")
  orderIndex  Int      @default(0)
  
  createdAt   DateTime @default(now())
  
  @@index([deckId])
}

model CustomStudyNotes {
  id          String   @id @default(cuid())
  scenarioId  String
  scenario    CustomScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  
  title       String
  content     String   @db.Text
  sections    Json     @default("[]")
  generatedBy String   @default("ai")
  awsServices Json     @default("[]")
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([scenarioId])
}

model CustomQuiz {
  id          String   @id @default(cuid())
  scenarioId  String
  scenario    CustomScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  quizType    String   @default("standard")
  timeLimit   Int?
  passingScore Int     @default(70)
  questionCount Int    @default(10)
  generatedBy String   @default("ai")
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  questions   CustomQuizQuestion[]
  
  @@index([scenarioId])
}

model CustomQuizQuestion {
  id          String   @id @default(cuid())
  quizId      String
  quiz        CustomQuiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  question    String   @db.Text
  questionType String  @default("multiple_choice")
  options     Json     @default("[]")
  explanation String?  @db.Text
  difficulty  String   @default("medium")
  points      Int      @default(10)
  awsServices Json     @default("[]")
  orderIndex  Int      @default(0)
  
  createdAt   DateTime @default(now())
  
  @@index([quizId])
}

model CustomCoachingSession {
  id          String   @id @default(cuid())
  profileId   String
  scenarioId  String
  scenario    CustomScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  
  title       String   @default("Coaching Session")
  status      String   @default("active")
  messageCount Int     @default(0)
  
  startedAt   DateTime @default(now())
  lastMessageAt DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  messages    CustomCoachingMessage[]
  
  @@index([profileId])
  @@index([scenarioId])
}

model CustomCoachingMessage {
  id          String   @id @default(cuid())
  sessionId   String
  session     CustomCoachingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  role        String
  content     String   @db.Text
  contentType String   @default("text")
  metadata    Json     @default("{}")
  
  createdAt   DateTime @default(now())
  
  @@index([sessionId])
}

// ============================================
// CloudAcademy - RAG Knowledge Base
// AWS & Migration Expert Knowledge
// ============================================

// Knowledge source - mirrors crawl4ai "sources" table structure
// Separate from main crawled_pages - this is for agent learning knowledge
model AcademyKnowledgeSource {
  id              String   @id  // source_id (domain/path)
  
  // Core fields matching crawl4ai sources
  summary         String?  @db.Text
  totalWordCount  Int      @default(0)
  
  // Extended metadata for learning context
  title           String?
  category        String?  // aws_service, migration, architecture, etc.
  awsServices     Json     @default("[]")
  tags            Json     @default("[]")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  chunks          AcademyKnowledgeChunk[]
  codeExamples    AcademyCodeExample[]
  
  @@index([category])
}

// Knowledge chunk - mirrors crawl4ai "crawled_pages" table structure
// Separate table for agent learning knowledge
model AcademyKnowledgeChunk {
  id          Int      @id @default(autoincrement())
  
  // Core fields matching crawl4ai crawled_pages
  url         String
  chunkNumber Int
  content     String   @db.Text
  metadata    Json     @default("{}")
  sourceId    String
  source      AcademyKnowledgeSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  
  // Vector embedding for semantic search (same dimension as crawl4ai)
  embedding   Unsupported("vector(1536)")?
  
  createdAt   DateTime @default(now())
  
  @@unique([url, chunkNumber])
  @@index([sourceId])
  @@index([url])
}

// Code examples - mirrors crawl4ai "code_examples" table structure
model AcademyCodeExample {
  id          Int      @id @default(autoincrement())
  
  url         String
  chunkNumber Int
  content     String   @db.Text  // The code
  summary     String   @db.Text  // AI summary of the code
  metadata    Json     @default("{}")
  sourceId    String
  source      AcademyKnowledgeSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  
  // Vector embedding
  embedding   Unsupported("vector(1536)")?
  
  createdAt   DateTime @default(now())
  
  @@unique([url, chunkNumber])
  @@index([sourceId])
}

// Pre-built Q&A pairs for common questions
model AcademyKnowledgeQA {
  id          String   @id @default(cuid())
  
  // Question
  question    String   @db.Text
  questionVariants Json @default("[]")  // Alternative phrasings
  
  // Answer
  answer      String   @db.Text
  
  // Categorization
  category    String   // aws_service, migration, architecture, troubleshooting
  awsServices Json     @default("[]")
  migrationCategories Json @default("[]")
  tags        Json     @default("[]")
  
  // Difficulty
  difficulty  String   @default("intermediate")
  
  // Source references
  sourceChunkIds Json  @default("[]")  // Links to knowledge chunks
  externalLinks Json   @default("[]")  // [{ title, url }]
  
  // Quality
  isVerified  Boolean  @default(false)
  upvotes     Int      @default(0)
  downvotes   Int      @default(0)
  
  // Embedding for semantic matching
  embedding   Unsupported("vector(1536)")?
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([category])
  @@index([isActive])
}

// AWS Service reference - structured data about each service
model AWSServiceReference {
  id          String   @id @default(cuid())
  
  // Service identification
  serviceName String   @unique  // "EC2", "S3", "Lambda"
  serviceCode String   @unique  // "ec2", "s3", "lambda"
  fullName    String   // "Amazon Elastic Compute Cloud"
  
  // Categorization
  category    String   // compute, storage, database, networking, security, etc.
  
  // Description
  shortDescription String
  fullDescription String? @db.Text
  
  // Use cases
  useCases    Json     @default("[]")  // ["web hosting", "batch processing"]
  
  // Migration mapping (on-prem equivalents)
  onPremEquivalents Json @default("[]")  // ["VMware", "Hyper-V", "physical servers"]
  migrationCategory String?  // Maps to your 12 categories
  
  // Pricing model
  pricingModel String?  // on_demand, reserved, spot, free_tier
  hasFreeeTier Boolean @default(false)
  
  // Compliance
  complianceCertifications Json @default("[]")  // ["HIPAA", "PCI-DSS", "SOC2"]
  
  // Related services
  relatedServices Json  @default("[]")  // ["EBS", "ELB", "Auto Scaling"]
  
  // Documentation links
  docsUrl     String?
  pricingUrl  String?
  
  // Icon/branding
  iconUrl     String?
  color       String?  // Brand color hex
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([category])
  @@index([migrationCategory])
}

// Migration pattern templates
model MigrationPattern {
  id          String   @id @default(cuid())
  
  // Pattern identification
  name        String
  slug        String   @unique
  
  // What it migrates
  sourceType  String   // "vmware_vm", "sql_server", "file_share", etc.
  targetService String // "EC2", "RDS", "FSx"
  
  // Categorization
  migrationCategory String  // One of your 12 categories
  
  // Description
  shortDescription String
  fullDescription String @db.Text
  
  // The pattern
  steps       Json     // [{ order, title, description, awsServices, estimatedTime }]
  
  // Prerequisites
  prerequisites Json   @default("[]")
  
  // AWS services involved
  awsServices Json     @default("[]")
  
  // Complexity & time
  complexity  String   @default("medium")  // low, medium, high, expert
  estimatedHours Int?
  
  // Risks and considerations
  risks       Json     @default("[]")
  considerations Json  @default("[]")
  
  // Cost factors
  costFactors Json     @default("[]")
  
  // Success criteria
  successCriteria Json @default("[]")
  
  // Related patterns
  relatedPatterns Json @default("[]")
  
  // Diagram/architecture
  architectureDiagram String? @db.Text  // Mermaid or similar
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([migrationCategory])
  @@index([sourceType])
  @@index([targetService])
}

// Well-Architected Framework reference
model WellArchitectedPrinciple {
  id          String   @id @default(cuid())
  
  // Pillar
  pillar      String   // operational_excellence, security, reliability, 
                       // performance_efficiency, cost_optimization, sustainability
  
  // Principle
  name        String
  slug        String   @unique
  description String   @db.Text
  
  // Best practices
  bestPractices Json   @default("[]")  // [{ title, description, services }]
  
  // Anti-patterns
  antiPatterns Json    @default("[]")
  
  // Questions to ask
  reviewQuestions Json @default("[]")
  
  // Related AWS services
  awsServices Json     @default("[]")
  
  // Documentation
  docsUrl     String?
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  
  @@index([pillar])
}

// ============================================
// CloudAcademy Arena - Gaming System
// ============================================

// Game Profile - Player's gaming stats and ranking
model GameProfile {
  id              String   @id @default(cuid())
  
  // Link to user
  userId          String   @unique
  user            AcademyUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Display
  displayName     String?
  avatarUrl       String?
  avatarFrame     String?  // Unlockable frame
  title           String?  // "AWS Champion", "Quiz Master", etc.
  countryCode     String?  // "GB", "US", etc. for flags
  
  // Elo Rating System (like Chess)
  elo             Int      @default(1500)
  peakElo         Int      @default(1500)
  
  // Rank derived from Elo
  // Bronze: 0-1199, Silver: 1200-1499, Gold: 1500-1799, 
  // Platinum: 1800-2099, Diamond: 2100-2399, Master: 2400+
  rank            String   @default("Silver")
  rankTier        Int      @default(3)  // 1-3 within rank (Gold I, Gold II, Gold III)
  
  // Overall Stats
  totalGames      Int      @default(0)
  totalWins       Int      @default(0)
  totalLosses     Int      @default(0)
  totalDraws      Int      @default(0)
  winStreak       Int      @default(0)
  bestWinStreak   Int      @default(0)
  
  // Points (separate from Elo - for rewards/unlocks)
  totalPoints     Int      @default(0)
  seasonPoints    Int      @default(0)
  weeklyPoints    Int      @default(0)
  
  // Game-specific stats (JSON for flexibility)
  quizBattleStats Json     @default("{}")  // { games, wins, avgScore, fastestBuzz }
  survivalStats   Json     @default("{}")  // { highScore, gamesPlayed, avgSurvival }
  arenaStats      Json     @default("{}")  // { games, wins, avgRating }
  scrambleStats   Json     @default("{}")  // { games, wins, bestTime }
  defusalStats    Json     @default("{}")  // { games, wins, bombsDefused }
  serviceSlotsStats Json   @default("{}")  // { balance, totalWinnings, gamesPlayed, gamesWon, currentStreak, bestStreak }
  
  // Activity
  lastPlayedAt    DateTime?
  lastMatchId     String?
  
  // Preferences
  preferredRegion String   @default("auto")  // auto, eu-west, us-east, etc.
  preferredMode   String   @default("ranked")  // ranked, casual
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([elo])
  @@index([rank])
  @@index([totalPoints])
  @@index([seasonPoints])
}

// Game Types - Defines available games
model GameType {
  id              String   @id @default(cuid())
  
  slug            String   @unique  // quiz_battle, survival, architect_arena, etc.
  name            String            // "Quiz Battle"
  description     String   @db.Text
  icon            String            // Emoji or icon name
  
  // Game settings
  minPlayers      Int      @default(1)
  maxPlayers      Int      @default(2)
  isTeamGame      Boolean  @default(false)
  
  // Modes available
  hasRanked       Boolean  @default(true)
  hasCasual       Boolean  @default(true)
  hasPractice     Boolean  @default(true)
  
  // Status
  isActive        Boolean  @default(true)
  isBeta          Boolean  @default(false)
  comingSoon      Boolean  @default(false)
  
  // Stats (denormalized)
  totalMatches    Int      @default(0)
  activePlayers   Int      @default(0)  // Updated periodically
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  matches         GameMatch[]
  
  @@index([isActive])
  @@index([slug])
}

// Game Match - Individual game sessions
model GameMatch {
  id              String   @id @default(cuid())
  matchCode       String   @unique  // For joining/spectating
  
  // Game type
  gameTypeId      String
  gameType        GameType @relation(fields: [gameTypeId], references: [id])
  
  // Mode
  mode            String   @default("ranked")  // ranked, casual, practice
  
  // Players (supports 1v1 for now, expandable)
  player1Id       String
  player1         AcademyUser @relation("GameMatchPlayer1", fields: [player1Id], references: [id], onDelete: Cascade)
  player2Id       String?
  player2         AcademyUser? @relation("GameMatchPlayer2", fields: [player2Id], references: [id], onDelete: Cascade)
  
  // For team games (future)
  team1           Json     @default("[]")  // [userId, userId]
  team2           Json     @default("[]")
  
  // Scores
  player1Score    Int      @default(0)
  player2Score    Int      @default(0)
  
  // Result
  status          String   @default("pending")  // pending, active, completed, cancelled, abandoned
  winnerId        String?
  isDraw          Boolean  @default(false)
  
  // Elo changes (calculated on completion)
  player1EloChange Int?
  player2EloChange Int?
  player1EloBefore Int?
  player2EloBefore Int?
  
  // Game state (flexible JSON for different game types)
  gameState       Json     @default("{}")
  
  // For replays/spectating
  replayData      Json     @default("[]")  // Array of game events
  
  // Region
  region          String   @default("auto")
  
  // Timestamps
  createdAt       DateTime @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  
  @@index([gameTypeId])
  @@index([player1Id])
  @@index([player2Id])
  @@index([status])
  @@index([mode])
  @@index([matchCode])
  @@index([createdAt])
}

// Matchmaking Queue - Players waiting for matches
model MatchmakingQueue {
  id              String   @id @default(cuid())
  
  userId          String   @unique
  user            AcademyUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // What they're looking for
  gameType        String   // quiz_battle, survival, etc.
  mode            String   @default("ranked")  // ranked, casual
  
  // Matching criteria
  elo             Int      // Snapshot of user's Elo when queued
  eloRange        Int      @default(200)  // Will match within +/- this range
  
  // Region preferences
  preferredRegion String   @default("auto")
  allowCrossRegion Boolean @default(true)
  
  // Queue timing
  queuedAt        DateTime @default(now())
  expandedAt      DateTime?  // When we started expanding search
  
  // Status
  status          String   @default("searching")  // searching, matched, expired
  matchedWith     String?  // UserId of matched opponent
  matchId         String?  // Created match ID
  
  @@index([gameType])
  @@index([mode])
  @@index([elo])
  @@index([status])
  @@index([queuedAt])
}

// Leaderboard Cache - Pre-computed for performance
model LeaderboardEntry {
  id              String   @id @default(cuid())
  
  // Leaderboard type
  leaderboardType String   // global, regional, weekly, season, game_specific
  gameType        String?  // null for overall, or specific game
  region          String?  // null for global
  seasonId        String?  // null for all-time
  
  // Player
  userId          String
  displayName     String
  avatarUrl       String?
  countryCode     String?
  
  // Stats
  rank            Int
  elo             Int
  points          Int
  wins            Int
  games           Int
  winRate         Float
  
  // Computed at
  computedAt      DateTime @default(now())
  
  @@unique([leaderboardType, gameType, region, seasonId, userId])
  @@index([leaderboardType])
  @@index([gameType])
  @@index([region])
  @@index([rank])
}

// Seasons - For seasonal rankings and rewards
model GameSeason {
  id              String   @id @default(cuid())
  
  name            String   // "Season 1: AWS Foundations"
  slug            String   @unique
  description     String?  @db.Text
  
  // Timing
  startDate       DateTime
  endDate         DateTime
  
  // Rewards
  rewards         Json     @default("[]")  // [{ rank: "Gold", reward: "Avatar Frame" }]
  
  // Status
  isActive        Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  
  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
}

// Achievements - Unlockable badges/rewards
model GameAchievement {
  id              String   @id @default(cuid())
  
  slug            String   @unique  // first_win, win_streak_10, etc.
  name            String            // "First Victory"
  description     String
  icon            String            // Emoji or icon
  
  // Rarity
  rarity          String   @default("common")  // common, uncommon, rare, epic, legendary
  
  // Requirements (flexible JSON)
  requirements    Json     @default("{}")  // { type: "wins", count: 1 } or { type: "streak", count: 10 }
  
  // Rewards
  pointsReward    Int      @default(0)
  titleReward     String?  // Unlockable title
  frameReward     String?  // Unlockable avatar frame
  
  // Category
  category        String   @default("general")  // general, quiz_battle, survival, etc.
  
  // Hidden achievements (spoiler-free)
  isHidden        Boolean  @default(false)
  
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  
  unlocks         GameAchievementUnlock[]
  
  @@index([category])
  @@index([rarity])
}

// Achievement Unlocks - Track who unlocked what
model GameAchievementUnlock {
  id              String   @id @default(cuid())
  
  userId          String
  user            AcademyUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  achievementId   String
  achievement     GameAchievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  // When and how
  unlockedAt      DateTime @default(now())
  matchId         String?  // Which match triggered it
  
  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
  @@index([unlockedAt])
}

// ============================================
// Practice Exams - AWS Certification Prep
// ============================================

// Practice Exam - Certification exam simulation
model PracticeExam {
  id                String   @id @default(cuid())
  
  // Exam identity
  slug              String   @unique  // "saa-c03", "sap-c02", "dva-c02"
  title             String            // "AWS Solutions Architect Associate"
  shortTitle        String?           // "SAA-C03"
  certificationCode String            // "SAA-C03"
  
  // Description
  description       String   @db.Text
  
  // Exam simulation settings (matches real AWS exams)
  questionCount     Int      @default(65)   // Questions per attempt
  timeLimit         Int      @default(130)  // Minutes
  passingScore      Int      @default(72)   // Percentage to pass
  
  // Question pool
  totalQuestions    Int      @default(0)    // Total questions in pool
  
  // Domains/Categories (AWS exam domains)
  domains           Json     @default("[]") // [{ id, name, weight }]
  
  // Pricing/Access
  isFree            Boolean  @default(false)
  requiredTier      String   @default("learner")  // free, learner, pro
  price             Float?   // For individual purchase
  
  // Display
  icon              String   @default("üìù")
  color             String   @default("#FF9900")  // AWS Orange
  difficulty        String   @default("associate")  // foundational, associate, professional, specialty
  
  // Stats (denormalized for performance)
  totalAttempts     Int      @default(0)
  avgScore          Float    @default(0)
  passRate          Float    @default(0)
  
  // Metadata
  lastUpdated       DateTime @default(now())  // When questions were last updated
  examVersion       String?  // "2024" for versioned exams
  isActive          Boolean  @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  questions         ExamQuestion[]
  attempts          ExamAttempt[]
  
  @@index([certificationCode])
  @@index([difficulty])
  @@index([isActive])
  @@index([requiredTier])
}

// Exam Question - Individual practice question
model ExamQuestion {
  id                String   @id @default(cuid())
  
  examId            String
  exam              PracticeExam @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  // Question content
  questionText      String   @db.Text
  questionType      String   @default("single")  // single, multiple (select X)
  selectCount       Int      @default(1)         // For "select 2" or "select 3" questions
  
  // Scenario/context (for scenario-based questions)
  scenario          String?  @db.Text
  
  // Options
  options           Json     // [{ id: "A", text: "...", isCorrect: false }, ...]
  correctAnswers    Json     // ["A"] or ["A", "C"] for multi-select
  
  // Detailed explanation for learning
  explanation       String   @db.Text
  whyCorrect        String?  @db.Text  // Why the correct answer is right
  whyWrong          Json     @default("{}")  // { "A": "This is wrong because...", "B": "..." }
  
  // Domain categorization (maps to AWS exam domains)
  domain            String   // "Design Secure Architectures"
  domainId          String?  // For structured domain reference
  subdomain         String?  // "Design secure access to AWS resources"
  
  // AWS services covered
  awsServices       Json     @default("[]")  // ["IAM", "KMS", "Secrets Manager"]
  
  // Difficulty & stats
  difficulty        String   @default("medium")  // easy, medium, hard
  correctRate       Float    @default(0)         // % of users who got it right
  totalAttempts     Int      @default(0)
  
  // Reference materials
  referenceLinks    Json     @default("[]")  // [{ title: "IAM Best Practices", url: "..." }]
  
  // Tags for filtering
  tags              Json     @default("[]")  // ["security", "iam", "best-practices"]
  
  // Question source & type
  sourceType        String   @default("ai_generated")  // official_pdf, ai_generated, community
  isDiagnostic      Boolean  @default(false)           // Part of initial diagnostic set
  diagnosticOrder   Int?                               // Order in diagnostic sequence (1-10)
  
  // For AI-generated questions
  generatedFromContext String? @db.Text                // RAG context used to generate
  generatedAt       DateTime?                          // When AI created it
  generatedModel    String?                            // "gpt-4", "claude-3", etc.
  
  // Quality control
  isVerified        Boolean  @default(false)           // Human-reviewed
  verifiedBy        String?                            // Admin who verified
  verifiedAt        DateTime?
  reportCount       Int      @default(0)               // User reports for issues
  reportReasons     Json     @default("[]")           // ["incorrect_answer", "unclear", ...]
  
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  answers           ExamAnswer[]
  
  @@index([examId])
  @@index([domain])
  @@index([difficulty])
  @@index([sourceType])
  @@index([isDiagnostic])
  @@index([isActive])
}

// Exam Attempt - User's exam session
model ExamAttempt {
  id                String   @id @default(cuid())
  
  profileId         String
  profile           AcademyUserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  examId            String
  exam              PracticeExam @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  // Attempt mode
  mode              String   @default("adaptive")  // adaptive, timed, review, domain_focus
  focusDomain       String?  // For domain_focus mode
  
  // Adaptive exam state
  isAdaptive        Boolean  @default(true)
  diagnosticComplete Boolean @default(false)          // Has user finished diagnostic phase?
  diagnosticProfile  Json    @default("{}")          // { "domain1": { correct: 2, total: 3, percentage: 66 }, ... }
  adaptiveStrategy   Json    @default("{}")          // { "focusDomains": ["Security"], "difficultyBias": "harder" }
  
  // Attempt state
  status            String   @default("in_progress")  // in_progress, diagnostic, adaptive, completed, abandoned, timed_out
  
  // Question set for this attempt (randomized from pool)
  questionIds       Json     @default("[]")  // [questionId, ...]
  questionOrder     Json     @default("[]")  // Shuffled order
  currentIndex      Int      @default(0)     // Current question index
  
  // Flagged questions (for review)
  flaggedQuestions  Json     @default("[]")  // [questionId, ...]
  
  // Results (populated on completion)
  score             Float?   // Percentage score
  passed            Boolean?
  correctCount      Int      @default(0)
  incorrectCount    Int      @default(0)
  unansweredCount   Int      @default(0)
  
  // Domain breakdown
  domainScores      Json     @default("{}")  // { "Domain 1": { correct: 5, total: 10, percentage: 50 } }
  
  // Time tracking
  startedAt         DateTime @default(now())
  completedAt       DateTime?
  timeSpentSeconds  Int      @default(0)
  timeRemaining     Int?     // Seconds remaining when paused/completed
  
  // Points earned (for gamification)
  pointsEarned      Int      @default(0)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  answers           ExamAnswer[]
  
  @@index([profileId])
  @@index([examId])
  @@index([status])
  @@index([startedAt])
}

// Exam Answer - User's answer to a question
model ExamAnswer {
  id                String   @id @default(cuid())
  
  attemptId         String
  attempt           ExamAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  
  questionId        String
  question          ExamQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  // User's selected answer(s)
  selectedOptions   Json     @default("[]")  // ["A"] or ["A", "C"]
  
  // Grading
  isCorrect         Boolean?
  isPartiallyCorrect Boolean @default(false)  // For multi-select
  
  // Time spent on this question
  timeSpentSeconds  Int      @default(0)
  
  // Was this question flagged for review?
  wasFlagged        Boolean  @default(false)
  
  // Confidence (optional - for analytics)
  confidence        String?  // low, medium, high
  
  answeredAt        DateTime @default(now())
  
  @@unique([attemptId, questionId])
  @@index([attemptId])
  @@index([questionId])
  @@index([isCorrect])
}

// Exam Analytics - Aggregated user performance
model ExamAnalytics {
  id                String   @id @default(cuid())
  
  profileId         String
  examId            String
  
  // Aggregated stats
  totalAttempts     Int      @default(0)
  bestScore         Float    @default(0)
  avgScore          Float    @default(0)
  passCount         Int      @default(0)
  
  // Domain performance
  domainPerformance Json     @default("{}")  // { "Domain 1": { attempts: 10, avgScore: 75 } }
  
  // Weak areas (auto-identified)
  weakDomains       Json     @default("[]")  // ["Domain 2", "Domain 4"]
  weakServices      Json     @default("[]")  // ["Lambda", "API Gateway"]
  
  // Time stats
  avgTimeSeconds    Int      @default(0)
  totalTimeSeconds  Int      @default(0)
  
  // Readiness score (0-100, based on recent performance)
  readinessScore    Int      @default(0)
  readinessUpdatedAt DateTime?
  
  // Last activity
  lastAttemptAt     DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([profileId, examId])
  @@index([profileId])
  @@index([examId])
  @@index([readinessScore])
}

// ============================================
// Exam Configuration - Certification Metadata
// ============================================

// AWS Certification - Master list of all certifications
model AWSCertification {
  id                String   @id @default(cuid())
  
  // Certification identity
  code              String   @unique  // "SAA-C03", "DVA-C02", "CLF-C02"
  name              String            // "AWS Certified Solutions Architect - Associate"
  shortName         String            // "Solutions Architect Associate"
  
  // Level & category
  level             String            // foundational, associate, professional, specialty
  category          String?           // "Architect", "Developer", "Operations", "Data", "Security"
  
  // Exam details
  questionCount     Int      @default(65)   // Questions in real exam
  timeMinutes       Int      @default(130)  // Time limit
  passingScore      Int      @default(720)  // AWS uses 100-1000 scale
  passingPercentage Int      @default(72)   // Approximate percentage
  
  // Official resources
  examGuideUrl      String?  // URL to exam guide PDF
  sampleQuestionsUrl String? // URL to sample questions PDF
  awsPageUrl        String?  // URL to AWS certification page
  
  // Domains (from exam guide)
  domains           Json     @default("[]")  // [{ id: "1", name: "Design Secure Architectures", weight: 30, taskStatements: [...] }]
  
  // Status
  isActive          Boolean  @default(true)
  retiredAt         DateTime?
  replacedBy        String?  // Code of replacement cert (e.g., "SAA-C03" replaced "SAA-C02")
  
  // Metadata
  lastUpdated       DateTime @default(now())  // When exam guide was last updated
  version           String?  // "C03", "C02"
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  diagnosticSets    DiagnosticQuestionSet[]
  
  @@index([level])
  @@index([isActive])
}

// Diagnostic Question Set - Official questions for each certification
model DiagnosticQuestionSet {
  id                String   @id @default(cuid())
  
  certificationId   String
  certification     AWSCertification @relation(fields: [certificationId], references: [id], onDelete: Cascade)
  
  // Set metadata
  name              String   @default("Official Sample Questions")
  description       String?  @db.Text
  
  // Source
  sourceUrl         String?  // PDF URL
  sourceName        String   @default("AWS Official")  // "AWS Official", "Community", etc.
  
  // Questions in this set (ordered)
  questionIds       Json     @default("[]")  // [questionId, ...] in diagnostic order
  questionCount     Int      @default(10)
  
  // Domain coverage
  domainCoverage    Json     @default("{}")  // { "Domain 1": 3, "Domain 2": 2, ... }
  
  // Status
  isActive          Boolean  @default(true)
  isPrimary         Boolean  @default(true)  // Primary diagnostic set for this cert
  
  // Import metadata
  importedAt        DateTime?
  importedBy        String?
  parseErrors       Json     @default("[]")  // Any errors during PDF parsing
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([certificationId])
  @@index([isActive])
  @@index([isPrimary])
}

// Diagram Audit Tips - "Tip Jar" for storing AI feedback on architecture diagrams
model DiagramAuditTip {
  id                  String @id @default(cuid())
  challengeProgressId String
  profileId           String

  // Audit result data
  auditScore Int    // Score from 0-100
  category   String // "correct", "missing", "suggestion", "feedback"
  content    String // The actual tip/feedback text

  // Context
  diagramSnapshot     Json? // Optional: snapshot of diagram state when tip was given
  awsServicesInvolved Json  @default("[]") // AWS services related to this tip

  // User interaction
  isDismissed Boolean   @default(false)
  dismissedAt DateTime?
  isHelpful   Boolean?  // User can mark tips as helpful or not
  userNotes   String?   // User can add notes to tips

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  challengeProgress ChallengeProgress @relation(fields: [challengeProgressId], references: [id], onDelete: Cascade)

  @@index([challengeProgressId])
  @@index([profileId])
  @@index([isDismissed])
  @@index([category])
}

// External Resources - YouTube videos, AWS docs, user-added content
model ExternalResource {
  id          String   @id @default(cuid())
  
  profileId   String
  profile     AcademyUserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Resource info
  title       String
  url         String
  type        String   // "video", "documentation", "course", "article"
  source      String   // "youtube", "aws", "user" (user-added), "study-guide" (auto-added)
  
  // For YouTube videos
  videoId     String?  // YouTube video ID for embedding
  thumbnailUrl String? // YouTube thumbnail
  duration    String?  // Video duration if available
  channelName String?  // YouTube channel name
  
  // Metadata
  certification String? // Which cert this relates to (from user's targetCertification)
  tags        Json     @default("[]")
  notes       String?  @db.Text // User's personal notes
  
  // Tracking
  isWatched   Boolean  @default(false)
  watchedAt   DateTime?
  isFavorite  Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([profileId])
  @@index([type])
  @@index([source])
  @@index([certification])
  @@index([isFavorite])
}
