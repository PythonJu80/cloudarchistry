services:
  postgres:
    image: pgvector/pgvector:pg16
    restart: unless-stopped
    ports:
      - "6070:5432"
    environment:
      - POSTGRES_USER=cloudmigrate
      - POSTGRES_PASSWORD=cloudmigrate2025
      - POSTGRES_DB=cloudmigrate
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cloudmigrate"]
      interval: 5s
      timeout: 5s
      retries: 5
    profiles:
      - prod
      - dev

  # # prod container (main CloudMigrate app) (DISABLED)
  # prod:
  #   image: node:20-slim
  #   restart: unless-stopped
  #   working_dir: /app
  #   ports:
  #     - "6080:3000"
  #   env_file:
  #     - .env
  #   environment:
  #     - DATABASE_URL=postgresql://cloudmigrate:cloudmigrate2025@postgres:5432/cloudmigrate
  #     - NEXTAUTH_URL=http://localhost:6080
  #     - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
  #     - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
  #     - AWS_REGION=${AWS_REGION:-us-east-1}
  #     - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
  #     - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY:-}
  #     - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
  #     - STRIPE_PRO_PRICE_ID=${STRIPE_PRO_PRICE_ID:-}
  #     - STRIPE_ENTERPRISE_PRICE_ID=${STRIPE_ENTERPRISE_PRICE_ID:-}
  #     - NEO4J_URI=bolt://neo4j:7687
  #     - NEO4J_USER=neo4j
  #     - NEO4J_PASSWORD=cloudmigrate2025
  #     - REDIS_URL=redis://redis:6379
  #     - NEXT_PUBLIC_GRAFANA_URL=http://localhost:6091
  #     - NEXT_PUBLIC_CRAWL4AI_URL=http://localhost:1021
  #   volumes:
  #     - .:/app
  #     - node_modules:/app/node_modules
  #     - ${HOME}:/user-home:ro  # Mount user's home directory (read-only)
  #   command: bash -c "apt-get update && apt-get install -y openssl && npm install && npx prisma generate && npx prisma db push --skip-generate && npm run prod"
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     neo4j:
  #       condition: service_started
  #     redis:
  #       condition: service_started
  #     crawl4ai:
  #       condition: service_started
  #   profiles:
  #     - prod

  # Redis - Job queues, caching, event bus
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "4379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - prod
      - dev

  # Neo4j Graph Database - Multi-tenant knowledge graphs
  neo4j:
    image: neo4j:5.15.0-community
    restart: unless-stopped
    ports:
      - "6085:7474"  # Browser UI
      - "6086:7687"  # Bolt protocol
    environment:
      - NEO4J_AUTH=neo4j/cloudmigrate2025
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*,gds.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*,gds.*
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    profiles:
      - prod
      - dev

  # # Prometheus - Metrics collection (DISABLED)
  # prometheus:
  #   image: prom/prometheus:v2.47.0
  #   restart: unless-stopped
  #   ports:
  #     - "6090:9090"
  #   volumes:
  #     - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
  #     - prometheus_data:/prometheus
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #     - '--storage.tsdb.path=/prometheus'
  #     - '--web.enable-lifecycle'
  #   profiles:
  #     - prod

  # # Grafana - Metrics visualization (DISABLED)
  # grafana:
  #   image: grafana/grafana:10.2.0
  #   restart: unless-stopped
  #   ports:
  #     - "6091:3000"
  #   environment:
  #     - GF_SECURITY_ADMIN_USER=admin
  #     - GF_SECURITY_ADMIN_PASSWORD=cloudmigrate2025
  #     - GF_USERS_ALLOW_SIGN_UP=false
  #     - GF_AUTH_ANONYMOUS_ENABLED=true
  #     - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
  #     - GF_SECURITY_ALLOW_EMBEDDING=true
  #     - GF_SERVER_ROOT_URL=http://localhost:6091
  #   volumes:
  #     - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
  #     - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
  #     - grafana_data:/var/lib/grafana
  #   depends_on:
  #     - prometheus
  #   profiles:
  #     - prod

  # # CloudWatch Exporter (YACE) - AWS metrics to Prometheus (DISABLED)
  # yace:
  #   image: ghcr.io/nerdswords/yet-another-cloudwatch-exporter:v0.55.0
  #   restart: unless-stopped
  #   ports:
  #     - "6092:5000"
  #   volumes:
  #     - ./monitoring/yace-config.yml:/tmp/config.yml:ro
  #   environment:
  #     - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
  #     - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
  #     - AWS_REGION=${AWS_REGION:-us-east-1}
  #   command:
  #     - '--config.file=/tmp/config.yml'
  #     - '--listen-address=:5000'
  #   profiles:
  #     - prod

  # # Documentation site (Nextra) (DISABLED)
  # docs:
  #   image: node:20-slim
  #   restart: unless-stopped
  #   working_dir: /app
  #   ports:
  #     - "6081:3001"
  #   volumes:
  #     - ./docs-site:/app
  #     - docs_node_modules:/app/node_modules
  #   command: bash -c "npm install && npm run prod"
  #   profiles:
  #     - prod

  # # Crawl4AI RAG API - Web crawling and knowledge base (DISABLED)
  # crawl4ai:
  #   build:
  #     context: ./mcp-crawl4ai-rag
  #     dockerfile: Dockerfile
  #   ports:
  #     - "1021:1021"
  #   environment:
  #     - TRANSPORT=sse
  #     - HOST=0.0.0.0
  #     - PORT=1021
  #     - OPENAI_API_KEY=${OPENAI_API_KEY:-}
  #     - MODEL_CHOICE=gpt-4o-mini
  #     - USE_CONTEXTUAL_EMBEDDINGS=true
  #     - USE_HYBRID_SEARCH=true
  #     - USE_AGENTIC_RAG=true
  #     - USE_RERANKING=true
  #     - USE_KNOWLEDGE_GRAPH=true
  #     - NEO4J_URI=bolt://neo4j:7687
  #     - NEO4J_USER=neo4j
  #     - NEO4J_PASSWORD=cloudmigrate2025
  #     - DB_HOST=postgres
  #     - DB_PORT=5432
  #     - DB_USER=cloudmigrate
  #     - DB_PASSWORD=cloudmigrate2025
  #     - DB_NAME=cloudmigrate
  #     - REDIS_URL=redis://redis:6379
  #     - MAX_CONCURRENT_CRAWLS_PER_TENANT=5
  #     - MAX_CRAWLS_PER_HOUR_PER_TENANT=20
  #     - JOB_EXPIRY_HOURS=24
  #     - DB_POOL_SIZE=20
  #     - MAX_PARALLEL_BATCHES=4
  #   volumes:
  #     - crawl4ai_data:/app/data
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     neo4j:
  #       condition: service_started
  #     redis:
  #       condition: service_started
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:1021/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   restart: unless-stopped
  #   profiles:
  #     - prod

  # # CloudMigrate prod container (DISABLED)
  # cloudmigrate:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   ports:
  #     - "6080:3000"
  #   environment:
  #     - DATABASE_URL=file:/app/data/prod.db
  #     - NEXTAUTH_URL=http://localhost:6080
  #     - NEXTAUTH_SECRET=your-super-secret-key-change-in-production
  #     - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
  #     - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
  #     - AWS_REGION=${AWS_REGION:-us-east-1}
  #   volumes:
  #     - cloudmigrate-data:/app/data
  #   restart: unless-stopped
  #   profiles:
  #     - prod


  # MinIO - Object storage for architecture diagrams
  minio:
    image: minio/minio:latest
    restart: unless-stopped
    ports:
      - "6093:9000"  # API
      - "6094:9001"  # Console
    environment:
      - MINIO_ROOT_USER=cloudmigrate
      - MINIO_ROOT_PASSWORD=cloudmigrate2025
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - prod
      - dev

  # Learning Agent - AI-powered scenario generator for CloudAcademy
  learning-agent:
    build:
      context: ./learning_agent
      dockerfile: Dockerfile
    ports:
      - "1027:1027"
    env_file:
      - ./learning_agent/.env
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:1027/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - prod
      - dev

  # Diagram Ingestion Service - Handles XML/VSDX uploads and validation (Production)
  diagram-ingestion:
    build:
      context: ./diagram-community
      dockerfile: ingestion/Dockerfile
    restart: unless-stopped
    ports:
      - "6095:8000"
    environment:
      - DATABASE_URL=postgresql://cloudmigrate:cloudmigrate2025@postgres:5432/cloudmigrate
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=cloudmigrate
      - MINIO_SECRET_KEY=cloudmigrate2025
      - MINIO_BUCKET=architecture-diagrams
      - REDIS_URL=redis://redis:6379
      - MAX_FILE_SIZE_MB=50
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - prod

  # Diagram Ingestion Service - Development with Hot Reload
  diagram-ingestion-dev:
    image: python:3.11-slim
    restart: unless-stopped
    working_dir: /app
    ports:
      - "6095:8000"
    environment:
      - DATABASE_URL=postgresql://cloudmigrate:cloudmigrate2025@postgres:5432/cloudmigrate
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=cloudmigrate
      - MINIO_SECRET_KEY=cloudmigrate2025
      - MINIO_BUCKET=architecture-diagrams
      - REDIS_URL=redis://redis:6379
      - MAX_FILE_SIZE_MB=50
      - PYTHONUNBUFFERED=1
    volumes:
      - ./diagram-community/ingestion:/app
      - ./diagram-community/shared:/app/shared
    command: bash -c "pip install -r requirements.txt && uvicorn main:app --host 0.0.0.0 --port 8000 --reload"
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_started
    profiles:
      - dev

  # Diagram Parser Service - Extracts AWS services and categorizes (Production)
  diagram-parser:
    build:
      context: ./diagram-community
      dockerfile: parser/Dockerfile
    restart: unless-stopped
    ports:
      - "6096:8001"
    environment:
      - DATABASE_URL=postgresql://cloudmigrate:cloudmigrate2025@postgres:5432/cloudmigrate
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=cloudmigrate
      - MINIO_SECRET_KEY=cloudmigrate2025
      - MINIO_BUCKET=architecture-diagrams
      - REDIS_URL=redis://redis:6379
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=cloudmigrate2025
      - LEARNING_AGENT_URL=http://learning-agent:1027
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_started
      neo4j:
        condition: service_started
      learning-agent:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - prod

  # Diagram Parser Service - Development with Hot Reload
  diagram-parser-dev:
    image: python:3.11-slim
    restart: unless-stopped
    working_dir: /app
    ports:
      - "6096:8001"
    environment:
      - DATABASE_URL=postgresql://cloudmigrate:cloudmigrate2025@postgres:5432/cloudmigrate
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=cloudmigrate
      - MINIO_SECRET_KEY=cloudmigrate2025
      - MINIO_BUCKET=architecture-diagrams
      - REDIS_URL=redis://redis:6379
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=cloudmigrate2025
      - LEARNING_AGENT_URL=http://learning-agent:1027
      - PYTHONUNBUFFERED=1
    volumes:
      - ./diagram-community/parser:/app
      - ./diagram-community/shared:/app/shared
    command: bash -c "pip install -r requirements.txt && uvicorn main:app --host 0.0.0.0 --port 8001 --reload"
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_started
      neo4j:
        condition: service_started
      learning-agent:
        condition: service_healthy
    profiles:
      - dev

  # Diagram API Gateway - REST API for cloud-academy integration (Production)
  diagram-api:
    build:
      context: ./diagram-community
      dockerfile: api/Dockerfile
    restart: unless-stopped
    ports:
      - "6097:8002"
    environment:
      - DATABASE_URL=postgresql://cloudmigrate:cloudmigrate2025@postgres:5432/cloudmigrate
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=cloudmigrate
      - MINIO_SECRET_KEY=cloudmigrate2025
      - MINIO_BUCKET=architecture-diagrams
      - REDIS_URL=redis://redis:6379
      - INGESTION_SERVICE_URL=http://diagram-ingestion:8000
      - PARSER_SERVICE_URL=http://diagram-parser:8001
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - prod

  # Diagram API Gateway - Development with Hot Reload
  diagram-api-dev:
    image: python:3.11-slim
    restart: unless-stopped
    working_dir: /app
    ports:
      - "6097:8002"
    environment:
      - DATABASE_URL=postgresql://cloudmigrate:cloudmigrate2025@postgres:5432/cloudmigrate
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=cloudmigrate
      - MINIO_SECRET_KEY=cloudmigrate2025
      - MINIO_BUCKET=architecture-diagrams
      - REDIS_URL=redis://redis:6379
      - INGESTION_SERVICE_URL=http://diagram-ingestion-dev:8000
      - PARSER_SERVICE_URL=http://diagram-parser-dev:8001
      - PYTHONUNBUFFERED=1
    volumes:
      - ./diagram-community/api:/app
      - ./diagram-community/shared:/app/shared
    command: bash -c "pip install -r requirements.txt && uvicorn main:app --host 0.0.0.0 --port 8002 --reload"
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_started
    profiles:
      - dev

  # CloudAcademy - Production Build
  cloud-academy:
    build:
      context: ./cloud-academy
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "6060:6060"
    env_file:
      - ./cloud-academy/.env
    environment:
      - NODE_ENV=production
      - PORT=6060
      - DATABASE_URL=postgresql://cloudmigrate:cloudmigrate2025@postgres:5432/cloudmigrate
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - DIAGRAM_API_URL=http://diagram-api:8002
    depends_on:
      postgres:
        condition: service_healthy
      learning-agent:
        condition: service_healthy
      diagram-api:
        condition: service_healthy
    profiles:
      - prod

  # CloudAcademy - Development with Hot Reload
  cloud-academy-dev:
    image: node:20-slim
    restart: unless-stopped
    working_dir: /app
    ports:
      - "6060:6060"
    env_file:
      - ./cloud-academy/.env
    environment:
      - NODE_ENV=development
      - PORT=6060
      - DATABASE_URL=postgresql://cloudmigrate:cloudmigrate2025@postgres:5432/cloudmigrate
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - DIAGRAM_API_URL=http://diagram-api-dev:8002
    volumes:
      - ./cloud-academy:/app
      - cloud_academy_node_modules:/app/node_modules
    command: bash -c "apt-get update && apt-get install -y openssl && npm install && npx prisma generate && npm run dev"
    depends_on:
      postgres:
        condition: service_healthy
      learning-agent:
        condition: service_healthy
    profiles:
      - dev

volumes:
  postgres_data:
  cloudmigrate-data:
  node_modules:
  docs_node_modules:
  neo4j_data:
  neo4j_logs:
  prometheus_data:
  grafana_data:
  redis_data:
  crawl4ai_data:
  cloud_academy_node_modules:
  minio_data: