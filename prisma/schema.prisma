generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                 String      @id @default(cuid())
  name               String
  slug               String      @unique
  plan               String      @default("FREE")
  awsRoleArn         String?
  awsExternalId      String?
  awsRegion          String      @default("us-east-1")
  defaultBucket      String?
  bytesTransferred   BigInt      @default(0)
  bytesLimit         BigInt      @default(5368709120)
  stripeCustomerId   String?
  stripeSubId        String?
  openaiApiKey       String?
  preferredModel     String?     @default("gpt-4.1")
  companyWebsite     String?
  companyContext     String?
  knowledgeUpdatedAt DateTime?
  agentApiKey        String?
  agentConnected     Boolean     @default(false)
  agentLastSeen      DateTime?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  agentScans         AgentScan[]
  buckets            Bucket[]
  secrets            Secret[]
  transfers          Transfer[]
  users              User[]
}

model User {
  id            String       @id @default(cuid())
  email         String       @unique
  name          String?
  passwordHash  String
  role          String       @default("USER")
  isSuperuser   Boolean      @default(false)
  emailVerified DateTime?
  tenantId      String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  chatThreads   ChatThread[]
  cloudFlows    CloudFlow[]
  transfers     Transfer[]
  tenant        Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model Bucket {
  id        String     @id @default(cuid())
  name      String
  region    String
  isDefault Boolean    @default(false)
  tenantId  String
  createdAt DateTime   @default(now())
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transfers Transfer[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Transfer {
  id            String    @id @default(cuid())
  fileName      String
  filePath      String
  fileSize      BigInt
  mimeType      String?
  s3Key         String
  bucketId      String
  status        String    @default("PENDING")
  progress      Int       @default(0)
  error         String?
  localChecksum String?
  s3Checksum    String?
  startedAt     DateTime?
  completedAt   DateTime?
  tenantId      String
  userId        String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  bucket        Bucket    @relation(fields: [bucketId], references: [id])
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([status])
}

model KnowledgeChunk {
  id        String   @id @default(cuid())
  source    String
  title     String?
  content   String
  embedding String
  metadata  String?
  createdAt DateTime @default(now())

  @@index([source])
}

model ChatThread {
  id        String        @id @default(cuid())
  title     String        @default("New Chat")
  userId    String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  messages  ChatMessage[]
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ChatMessage {
  id        String     @id @default(cuid())
  threadId  String
  role      String
  content   String
  type      String?
  data      String?
  createdAt DateTime   @default(now())
  thread    ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId])
}

model Secret {
  id        String   @id @default(cuid())
  tenantId  String
  key       String
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([tenantId])
}

model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String?
  action    String
  resource  String
  details   String?
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([createdAt])
}

model TenantNeo4jConfig {
  id                String   @id @default(cuid())
  tenantId          String   @unique
  boltUri           String   @default("bolt://neo4j:7687")
  username          String   @default("neo4j")
  password          String
  database          String
  configType        String   @default("SHARED")
  maxNodes          Int      @default(100000)
  maxRelationships  Int      @default(500000)
  gdsEnabled        Boolean  @default(false)
  embeddingsEnabled Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([tenantId])
}

model GraphUsage {
  id                     String   @id @default(cuid())
  tenantId               String
  computeSeconds         Int      @default(0)
  queriesExecuted        Int      @default(0)
  nodesProcessed         Int      @default(0)
  relationshipsProcessed Int      @default(0)
  embeddingsGenerated    Int      @default(0)
  periodStart            DateTime
  periodEnd              DateTime
  stripeReported         Boolean  @default(false)
  stripeUsageRecordId    String?
  createdAt              DateTime @default(now())

  @@unique([tenantId, periodStart, periodEnd])
  @@index([tenantId])
}

model GraphJobLog {
  id             String    @id @default(cuid())
  tenantId       String
  userId         String?
  algorithm      String
  status         String    @default("PENDING")
  nodesProcessed Int       @default(0)
  relsProcessed  Int       @default(0)
  executionMs    Int       @default(0)
  resultSummary  String?
  error          String?
  startedAt      DateTime?
  completedAt    DateTime?
  createdAt      DateTime  @default(now())

  @@index([tenantId])
  @@index([status])
}

model CloudResource {
  id             String        @id @default(cuid())
  tenantId       String
  type           String
  arn            String?
  awsId          String?
  name           String
  region         String
  status         String        @default("PENDING")
  config         String
  monthlyCost    Float         @default(0)
  lastCostSync   DateTime?
  tags           String?
  architectureId String?
  createdBy      String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  architecture   Architecture? @relation(fields: [architectureId], references: [id])

  @@unique([tenantId, arn])
  @@index([tenantId])
  @@index([type])
  @@index([status])
  @@index([architectureId])
}

model Architecture {
  id             String                   @id @default(cuid())
  tenantId       String
  userId         String
  name           String
  description    String?
  version        Int                      @default(1)
  nodes          String
  edges          String
  viewport       String?
  resources      String?
  status         String                   @default("draft")
  deployedAt     DateTime?
  deployError    String?
  estimatedCost  Float                    @default(0)
  isShared       Boolean                  @default(false)
  terraformCode  String?
  iamPolicies    String?
  createdBy      String?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  deployments    ArchitectureDeployment[]
  cloudResources CloudResource[]

  @@index([tenantId])
  @@index([userId])
  @@index([status])
}

model ArchitectureDeployment {
  id               String       @id @default(cuid())
  architectureId   String
  version          Int
  status           String       @default("PENDING")
  resourcesCreated Int          @default(0)
  resourcesUpdated Int          @default(0)
  resourcesDeleted Int          @default(0)
  logs             String?
  error            String?
  startedAt        DateTime?
  completedAt      DateTime?
  createdAt        DateTime     @default(now())
  architecture     Architecture @relation(fields: [architectureId], references: [id], onDelete: Cascade)

  @@index([architectureId])
}

model AlertRule {
  id            String          @id @default(cuid())
  tenantId      String
  name          String
  description   String?
  metric        String
  resourceType  String?
  resourceId    String?
  operator      String
  threshold     Float
  duration      Int             @default(300)
  channels      String
  channelConfig String
  enabled       Boolean         @default(true)
  lastTriggered DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  incidents     AlertIncident[]

  @@index([tenantId])
  @@index([enabled])
}

model CloudFlow {
  id            String          @id @default(cuid())
  tenantId      String
  userId        String
  name          String
  description   String?
  nodes         String
  edges         String
  viewport      String?
  triggerType   String          @default("manual")
  triggerConfig String?
  status        String          @default("draft")
  isShared      Boolean         @default(false)
  version       Int             @default(1)
  lastRunAt     DateTime?
  lastRunStatus String?
  runCount      Int             @default(0)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  executions    FlowExecution[]
  secrets       FlowSecret[]

  @@index([tenantId])
  @@index([userId])
  @@index([status])
}

model FlowSecret {
  id          String    @id @default(cuid())
  flowId      String
  secretKey   String
  nodeId      String?
  configField String?
  createdAt   DateTime  @default(now())
  flow        CloudFlow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@unique([flowId, secretKey, nodeId])
  @@index([flowId])
}

model FlowExecution {
  id          String    @id @default(cuid())
  flowId      String
  tenantId    String
  status      String    @default("pending")
  triggeredBy String
  results     String?
  logs        String?
  error       String?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  flow        CloudFlow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@index([flowId])
  @@index([tenantId])
  @@index([status])
}

model AlertIncident {
  id             String    @id @default(cuid())
  alertRuleId    String
  status         String    @default("OPEN")
  severity       String    @default("WARNING")
  value          Float
  message        String
  resourceArn    String?
  acknowledgedBy String?
  acknowledgedAt DateTime?
  resolvedAt     DateTime?
  createdAt      DateTime  @default(now())
  alertRule      AlertRule @relation(fields: [alertRuleId], references: [id], onDelete: Cascade)

  @@index([alertRuleId])
  @@index([status])
}

model VerificationToken {
  id        String   @id @default(cuid())
  token     String   @unique
  email     String
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([email])
}

model AgentScan {
  id          String   @id @default(cuid())
  tenantId    String
  scanPath    String
  fileCount   Int
  folderCount Int
  totalSize   BigInt
  fileTypes   Json
  largeFiles  Json
  createdAt   DateTime @default(now())
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model AgentCommand {
  id          String    @id @default(cuid())
  tenantId    String
  type        String
  payload     String
  status      String    @default("PENDING")
  result      String?
  error       String?
  createdAt   DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  @@index([tenantId])
  @@index([status])
}

model DiscoveryScan {
  id          String           @id @default(cuid())
  tenantId    String
  scanId      String
  networkCidr String
  startedAt   DateTime
  completedAt DateTime
  hostsFound  Int              @default(0)
  summary     String
  createdAt   DateTime         @default(now())
  hosts       DiscoveredHost[]

  @@index([tenantId])
  @@index([completedAt])
}

model DiscoveredHost {
  id              String         @id @default(cuid())
  tenantId        String
  ip              String
  hostname        String?
  mac             String?
  status          String         @default("online")
  os              String?
  osVersion       String?
  category        String
  awsTarget       String?
  openPorts       String
  services        String
  responseTimeMs  Int            @default(0)
  metadata        String?
  lastSeen        DateTime       @default(now())
  migrationStatus String         @default("discovered")
  migrationNotes  String?
  scanId          String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  scan            DiscoveryScan? @relation(fields: [scanId], references: [id])

  @@unique([tenantId, ip])
  @@index([tenantId])
  @@index([category])
  @@index([status])
  @@index([migrationStatus])
}

model MigrationWorkload {
  id            String    @id @default(cuid())
  tenantId      String
  name          String
  description   String?
  category      String
  sourceType    String
  sourceConfig  String
  awsService    String
  targetConfig  String
  status        String    @default("pending")
  progress      Int       @default(0)
  estimatedCost Float     @default(0)
  scheduledAt   DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  logs          String?
  error         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([tenantId])
  @@index([status])
  @@index([category])
}

model sources {
  source_id        String          @id
  tenant_id        String
  user_id          String          @default("default")
  summary          String?
  total_word_count Int             @default(0)
  created_at       DateTime        @default(now())
  updated_at       DateTime        @default(now())
  code_examples    code_examples[]
  crawled_pages    crawled_pages[]

  @@map("sources")
}

model crawled_pages {
  id           BigInt                 @id @default(autoincrement())
  url          String
  chunk_number Int
  content      String
  metadata     Json                   @default("{}")
  source_id    String
  tenant_id    String
  user_id      String                 @default("default")
  embedding    Unsupported("vector")?
  created_at   DateTime               @default(now())
  source       sources                @relation(fields: [source_id], references: [source_id])

  @@unique([url, chunk_number])
  @@index([source_id])
  @@index([tenant_id])
  @@index([user_id])
  @@map("crawled_pages")
}

model code_examples {
  id           BigInt                 @id @default(autoincrement())
  url          String
  chunk_number Int
  content      String
  summary      String
  metadata     Json                   @default("{}")
  source_id    String
  tenant_id    String
  user_id      String                 @default("default")
  embedding    Unsupported("vector")?
  created_at   DateTime               @default(now())
  source       sources                @relation(fields: [source_id], references: [source_id])

  @@unique([url, chunk_number])
  @@index([source_id])
  @@index([tenant_id])
  @@map("code_examples")
}

model reports {
  id              BigInt                 @id @default(autoincrement())
  report_id       String                 @unique
  source_id       String
  tenant_id       String?
  title           String
  report_content  String
  report_summary  String?
  focus_query     String?
  chunks_analyzed Int?
  model_used      String?
  metadata        Json                   @default("{}")
  embedding       Unsupported("vector")?
  created_at      DateTime               @default(now())

  @@index([source_id])
  @@index([tenant_id])
  @@map("reports")
}

model AcademyTenant {
  id                     String                  @id @default(cuid())
  name                   String
  slug                   String                  @unique
  plan                   String                  @default("FREE")
  stripeCustomerId       String?
  stripeSubId            String?
  openaiApiKey           String?
  preferredModel         String?                 @default("gpt-4.1")
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  activities             AcademyActivity[]
  secrets                AcademySecret[]
  teams                  AcademyTeam[]
  users                  AcademyUser[]
  profiles               AcademyUserProfile[]
  customLocations        CustomLocation[]
  customScenarios        CustomScenario[]
  customScenarioAttempts CustomScenarioAttempt[]
  scenarioAttempts       ScenarioAttempt[]
  teamChallengeAttempts  TeamChallengeAttempt[]
}

model AcademyUser {
  id            String              @id @default(cuid())
  email         String              @unique
  username      String?             @unique
  name          String?
  passwordHash  String
  role          String              @default("USER")
  emailVerified DateTime?
  tenantId      String
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  teamInvites   AcademyTeamInvite[]
  teamMembers   AcademyTeamMember[]
  tenant        AcademyTenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  profile       AcademyUserProfile?

  @@index([tenantId])
}

model AcademySecret {
  id        String        @id @default(cuid())
  tenantId  String
  key       String
  value     String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  tenant    AcademyTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([tenantId])
}

model AcademyTeam {
  id              String                 @id @default(cuid())
  tenantId        String?
  academyTenantId String?
  name            String
  slug            String
  description     String?
  avatarUrl       String?
  visibility      String                 @default("private")
  maxMembers      Int                    @default(10)
  totalPoints     Int                    @default(0)
  level           Int                    @default(1)
  settings        Json                   @default("{}")
  createdBy       String
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  academyTenant   AcademyTenant?         @relation(fields: [academyTenantId], references: [id], onDelete: Cascade)
  invites         AcademyTeamInvite[]
  members         AcademyTeamMember[]
  attempts        TeamChallengeAttempt[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([academyTenantId])
  @@index([visibility])
}

model AcademyTeamMember {
  id                  String       @id @default(cuid())
  teamId              String
  userId              String?
  academyUserId       String?
  role                String       @default("member")
  pointsContributed   Int          @default(0)
  challengesCompleted Int          @default(0)
  joinedAt            DateTime     @default(now())
  academyUser         AcademyUser? @relation(fields: [academyUserId], references: [id], onDelete: Cascade)
  team                AcademyTeam  @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([userId])
  @@index([academyUserId])
}

model AcademyTeamInvite {
  id            String       @id @default(cuid())
  teamId        String
  email         String?
  userId        String?
  academyUserId String?
  code          String       @unique
  role          String       @default("member")
  expiresAt     DateTime
  usedAt        DateTime?
  usedBy        String?
  createdBy     String
  createdAt     DateTime     @default(now())
  academyUser   AcademyUser? @relation(fields: [academyUserId], references: [id])
  team          AcademyTeam  @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([code])
  @@index([email])
  @@index([academyUserId])
}

model AcademyLocation {
  id                 String                 @id @default(cuid())
  slug               String                 @unique
  name               String
  company            String
  industry           String
  lat                Float
  lng                Float
  region             String?
  country            String?
  city               String?
  icon               String                 @default("üè¢")
  imageUrl           String?
  difficulty         String                 @default("intermediate")
  description        String
  compliance         Json                   @default("[]")
  tags               Json                   @default("[]")
  isLocked           Boolean                @default(false)
  unlockRequirements Json                   @default("[]")
  totalAttempts      Int                    @default(0)
  avgCompletionRate  Float                  @default(0)
  isActive           Boolean                @default(true)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  scenarios          AcademyScenario[]
  progress           UserLocationProgress[]

  @@index([industry])
  @@index([difficulty])
  @@index([region])
  @@index([isActive])
}

model AcademyScenario {
  id                     String                 @id @default(cuid())
  locationId             String
  title                  String
  description            String
  businessContext        String
  difficulty             String
  technicalRequirements  Json                   @default("[]")
  complianceRequirements Json                   @default("[]")
  constraints            Json                   @default("[]")
  learningObjectives     Json                   @default("[]")
  tags                   Json                   @default("[]")
  estimatedMinutes       Int                    @default(60)
  maxPoints              Int                    @default(1000)
  version                Int                    @default(1)
  targetLevel            String                 @default("intermediate")
  companyInfo            Json?
  isActive               Boolean                @default(true)
  generatedBy            String?
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  challenges             AcademyChallenge[]
  location               AcademyLocation        @relation(fields: [locationId], references: [id], onDelete: Cascade)
  coachingSessions       CoachingSession[]
  flashcardDecks         FlashcardDeck[]
  quizzes                Quiz[]
  attempts               ScenarioAttempt[]
  studyNotes             StudyNotes[]
  teamAttempts           TeamChallengeAttempt[]

  @@index([locationId])
  @@index([isActive])
  @@index([targetLevel])
  @@index([difficulty])
}

model AcademyChallenge {
  id                       String              @id @default(cuid())
  scenarioId               String
  title                    String
  description              String
  difficulty               String
  orderIndex               Int                 @default(0)
  points                   Int                 @default(100)
  bonusPoints              Int                 @default(0)
  hints                    Json                @default("[]")
  successCriteria          Json                @default("[]")
  awsServices              Json                @default("[]")
  solutionTemplate         Json?
  evaluationRubric         Json?
  estimatedMinutes         Int                 @default(15)
  timeLimitMinutes         Int?
  prerequisiteChallengeIds Json                @default("[]")
  createdAt                DateTime            @default(now())
  updatedAt                DateTime            @updatedAt
  scenario                 AcademyScenario     @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  progress                 ChallengeProgress[]

  @@index([scenarioId])
  @@index([orderIndex])
}

model AcademyUserProfile {
  id                         String                  @id @default(cuid())
  academyUserId              String?                 @unique
  academyTenantId            String?
  subscriptionTier           String                  @default("free")
  subscriptionExpiresAt      DateTime?
  hasAiAccess                Boolean                 @default(false)
  hasNeo4jAccess             Boolean                 @default(false)
  hasTeamAccess              Boolean                 @default(false)
  challengesStartedThisMonth Int                     @default(0)
  aiRequestsThisMonth        Int                     @default(0)
  usageResetAt               DateTime                @default(now())
  displayName                String?
  avatarUrl                  String?
  bio                        String?
  skillLevel                 String                  @default("intermediate")
  targetCertification        String?                 @default("SAA")
  preferredIndustries        Json                    @default("[]")
  preferredDifficulty        String?
  totalPoints                Int                     @default(0)
  level                      Int                     @default(1)
  xp                         Int                     @default(0)
  currentStreak              Int                     @default(0)
  longestStreak              Int                     @default(0)
  lastActivityDate           DateTime?
  achievements               Json                    @default("[]")
  challengesCompleted        Int                     @default(0)
  scenariosCompleted         Int                     @default(0)
  locationsVisited           Int                     @default(0)
  totalTimeMinutes           Int                     @default(0)
  settings                   Json                    @default("{}")
  openaiApiKey               String?
  openaiKeyLastFour          String?
  openaiKeyAddedAt           DateTime?
  preferredModel             String?                 @default("gpt-4.1")
  createdAt                  DateTime                @default(now())
  updatedAt                  DateTime                @updatedAt
  userId                     String?                 @unique
  tenantId                   String?
  awsAccessKeyId             String?
  awsSecretAccessKey         String?
  awsRegion                  String?                 @default("us-east-1")
  awsKeyLastFour             String?
  awsKeyAddedAt              DateTime?
  awsCredentialsValid        Boolean?                @default(false)
  academyTenant              AcademyTenant?          @relation(fields: [academyTenantId], references: [id], onDelete: Cascade)
  academyUser                AcademyUser?            @relation(fields: [academyUserId], references: [id], onDelete: Cascade)
  coachingSessions           CoachingSession[]
  customLocations            CustomLocation[]
  flashcardProgress          FlashcardUserProgress[]
  portfolios                 AcademyPortfolio[]
  quizAttempts               QuizAttempt[]
  scenarioAttempts           ScenarioAttempt[]
  studyNotesProgress         StudyNotesProgress[]
  locationProgress           UserLocationProgress[]

  @@index([tenantId])
  @@index([academyUserId])
  @@index([academyTenantId])
  @@index([totalPoints])
  @@index([level])
}

model UserLocationProgress {
  id                  String             @id @default(cuid())
  profileId           String
  locationId          String
  status              String             @default("not_started")
  firstVisitedAt      DateTime           @default(now())
  lastVisitedAt       DateTime           @default(now())
  completedAt         DateTime?
  totalPoints         Int                @default(0)
  challengesCompleted Int                @default(0)
  totalChallenges     Int                @default(0)
  timeSpentMinutes    Int                @default(0)
  bestAttemptId       String?
  location            AcademyLocation    @relation(fields: [locationId], references: [id], onDelete: Cascade)
  profile             AcademyUserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, locationId])
  @@index([profileId])
  @@index([locationId])
  @@index([status])
}

model ScenarioAttempt {
  id                String              @id @default(cuid())
  profileId         String
  scenarioId        String
  tenantId          String?
  academyTenantId   String?
  teamAttemptId     String?
  status            String              @default("in_progress")
  startedAt         DateTime            @default(now())
  lastActivityAt    DateTime            @default(now())
  completedAt       DateTime?
  pointsEarned      Int                 @default(0)
  maxPoints         Int                 @default(0)
  bonusPoints       Int                 @default(0)
  activeTimeMinutes Int                 @default(0)
  chatHistory       Json                @default("[]")
  metadata          Json                @default("{}")
  challengeProgress ChallengeProgress[]
  academyTenant     AcademyTenant?      @relation(fields: [academyTenantId], references: [id], onDelete: Cascade)
  profile           AcademyUserProfile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  scenario          AcademyScenario     @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([scenarioId])
  @@index([tenantId])
  @@index([academyTenantId])
  @@index([status])
  @@index([startedAt])
}

model ChallengeProgress {
  id               String            @id @default(cuid())
  attemptId        String
  challengeId      String
  status           String            @default("locked")
  unlockedAt       DateTime?
  startedAt        DateTime?
  completedAt      DateTime?
  pointsEarned     Int               @default(0)
  bonusEarned      Int               @default(0)
  hintsUsed        Int               @default(0)
  attemptsCount    Int               @default(0)
  timeSpentMinutes Int               @default(0)
  solution         Json?
  solutionNotes    String?
  feedback         Json?
  evaluatedAt      DateTime?
  attempt          ScenarioAttempt   @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  challenge        AcademyChallenge  @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  diagramAuditTips DiagramAuditTip[]

  @@unique([attemptId, challengeId])
  @@index([challengeId])
  @@index([status])
}

model TeamChallengeAttempt {
  id              String          @id @default(cuid())
  teamId          String
  scenarioId      String
  tenantId        String?
  academyTenantId String?
  status          String          @default("in_progress")
  startedAt       DateTime        @default(now())
  completedAt     DateTime?
  totalPoints     Int             @default(0)
  contributions   Json            @default("{}")
  discussion      Json            @default("[]")
  academyTenant   AcademyTenant?  @relation(fields: [academyTenantId], references: [id], onDelete: Cascade)
  scenario        AcademyScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  team            AcademyTeam     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, scenarioId])
  @@index([teamId])
  @@index([scenarioId])
  @@index([tenantId])
  @@index([academyTenantId])
  @@index([status])
}

model AcademyLeaderboard {
  id                  String   @id @default(cuid())
  scope               String
  scopeId             String?
  period              String
  periodKey           String
  entryType           String
  entryId             String
  displayName         String
  avatarUrl           String?
  totalPoints         Int      @default(0)
  challengesCompleted Int      @default(0)
  scenariosCompleted  Int      @default(0)
  locationsCompleted  Int      @default(0)
  averageScore        Float    @default(0)
  rank                Int      @default(0)
  previousRank        Int?
  updatedAt           DateTime @updatedAt

  @@unique([scope, scopeId, period, periodKey, entryType, entryId])
  @@index([scope, scopeId, period, periodKey, rank])
  @@index([entryType, entryId])
}

model AcademyAchievement {
  id           String   @id @default(cuid())
  slug         String   @unique
  name         String
  description  String
  icon         String
  rarity       String   @default("common")
  criteria     Json
  pointsReward Int      @default(0)
  xpReward     Int      @default(0)
  category     String   @default("general")
  isSecret     Boolean  @default(false)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  @@index([category])
  @@index([rarity])
}

model AcademyActivity {
  id              String         @id @default(cuid())
  profileId       String
  tenantId        String?
  teamId          String?
  academyTenantId String?
  type            String
  data            Json
  visibility      String         @default("tenant")
  createdAt       DateTime       @default(now())
  academyTenant   AcademyTenant? @relation(fields: [academyTenantId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([tenantId])
  @@index([academyTenantId])
  @@index([teamId])
  @@index([type])
  @@index([createdAt])
}

model FlashcardDeck {
  id           String                  @id @default(cuid())
  scenarioId   String
  title        String
  description  String?
  generatedBy  String                  @default("ai")
  aiModel      String?
  totalCards   Int                     @default(0)
  isActive     Boolean                 @default(true)
  createdAt    DateTime                @default(now())
  updatedAt    DateTime                @updatedAt
  cards        Flashcard[]
  scenario     AcademyScenario         @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  userProgress FlashcardUserProgress[]

  @@index([scenarioId])
}

model Flashcard {
  id           String              @id @default(cuid())
  deckId       String
  front        String
  back         String
  frontType    String              @default("text")
  backType     String              @default("text")
  tags         Json                @default("[]")
  difficulty   String              @default("medium")
  awsServices  Json                @default("[]")
  orderIndex   Int                 @default(0)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  deck         FlashcardDeck       @relation(fields: [deckId], references: [id], onDelete: Cascade)
  userProgress FlashcardProgress[]

  @@index([deckId])
  @@index([difficulty])
}

model FlashcardUserProgress {
  id               String              @id @default(cuid())
  profileId        String
  deckId           String
  cardsStudied     Int                 @default(0)
  cardsMastered    Int                 @default(0)
  totalReviews     Int                 @default(0)
  lastStudiedAt    DateTime?
  currentStreak    Int                 @default(0)
  totalTimeMinutes Int                 @default(0)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  cardProgress     FlashcardProgress[]
  deck             FlashcardDeck       @relation(fields: [deckId], references: [id], onDelete: Cascade)
  profile          AcademyUserProfile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, deckId])
  @@index([profileId])
  @@index([deckId])
}

model FlashcardProgress {
  id             String                @id @default(cuid())
  userProgressId String
  cardId         String
  easeFactor     Float                 @default(2.5)
  interval       Int                   @default(1)
  repetitions    Int                   @default(0)
  status         String                @default("new")
  nextReviewAt   DateTime?
  lastReviewAt   DateTime?
  totalReviews   Int                   @default(0)
  correctCount   Int                   @default(0)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  card           Flashcard             @relation(fields: [cardId], references: [id], onDelete: Cascade)
  userProgress   FlashcardUserProgress @relation(fields: [userProgressId], references: [id], onDelete: Cascade)

  @@unique([userProgressId, cardId])
  @@index([cardId])
  @@index([nextReviewAt])
  @@index([status])
}

model StudyNotes {
  id           String               @id @default(cuid())
  scenarioId   String
  title        String
  content      String
  sections     Json                 @default("[]")
  generatedBy  String               @default("ai")
  aiModel      String?
  awsServices  Json                 @default("[]")
  version      Int                  @default(1)
  isActive     Boolean              @default(true)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  annotations  StudyAnnotation[]
  scenario     AcademyScenario      @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  userProgress StudyNotesProgress[]

  @@index([scenarioId])
}

model StudyNotesProgress {
  id               String             @id @default(cuid())
  profileId        String
  notesId          String
  readProgress     Float              @default(0)
  sectionsRead     Json               @default("[]")
  totalTimeMinutes Int                @default(0)
  lastReadAt       DateTime?
  isBookmarked     Boolean            @default(false)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  notes            StudyNotes         @relation(fields: [notesId], references: [id], onDelete: Cascade)
  profile          AcademyUserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, notesId])
  @@index([profileId])
  @@index([notesId])
}

model StudyAnnotation {
  id           String     @id @default(cuid())
  profileId    String
  notesId      String
  type         String
  sectionId    String?
  startOffset  Int?
  endOffset    Int?
  selectedText String?
  userNote     String?
  color        String     @default("yellow")
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  notes        StudyNotes @relation(fields: [notesId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([notesId])
}

model CoachingSession {
  id                 String             @id @default(cuid())
  profileId          String
  scenarioId         String
  title              String             @default("Coaching Session")
  currentChallengeId String?
  currentMode        String?
  status             String             @default("active")
  messageCount       Int                @default(0)
  startedAt          DateTime           @default(now())
  lastMessageAt      DateTime?
  endedAt            DateTime?
  totalTimeMinutes   Int                @default(0)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  messages           CoachingMessage[]
  profile            AcademyUserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  scenario           AcademyScenario    @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([scenarioId])
  @@index([status])
}

model CoachingMessage {
  id          String          @id @default(cuid())
  sessionId   String
  role        String
  content     String
  contentType String          @default("text")
  metadata    Json            @default("{}")
  triggerType String?
  helpful     Boolean?
  createdAt   DateTime        @default(now())
  session     CoachingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([role])
}

model Quiz {
  id               String          @id @default(cuid())
  scenarioId       String
  title            String
  description      String?
  quizType         String          @default("standard")
  timeLimit        Int?
  passingScore     Int             @default(70)
  questionCount    Int             @default(10)
  shuffleQuestions Boolean         @default(true)
  shuffleOptions   Boolean         @default(true)
  showExplanations Boolean         @default(true)
  generatedBy      String          @default("ai")
  aiModel          String?
  difficultyMix    Json            @default("{\"easy\": 30, \"hard\": 20, \"medium\": 50}")
  totalAttempts    Int             @default(0)
  avgScore         Float           @default(0)
  isActive         Boolean         @default(true)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  scenario         AcademyScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  attempts         QuizAttempt[]
  questions        QuizQuestion[]

  @@index([scenarioId])
}

model QuizQuestion {
  id             String       @id @default(cuid())
  quizId         String
  question       String
  questionType   String       @default("multiple_choice")
  codeLanguage   String?
  codeSnippet    String?
  options        Json         @default("[]")
  expectedAnswer String?
  answerPatterns Json         @default("[]")
  explanation    String?
  difficulty     String       @default("medium")
  points         Int          @default(10)
  awsServices    Json         @default("[]")
  tags           Json         @default("[]")
  orderIndex     Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  answers        QuizAnswer[]
  quiz           Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([difficulty])
}

model QuizAttempt {
  id                String             @id @default(cuid())
  profileId         String
  quizId            String
  status            String             @default("in_progress")
  score             Float              @default(0)
  pointsEarned      Int                @default(0)
  maxPoints         Int                @default(0)
  questionsAnswered Int                @default(0)
  questionsCorrect  Int                @default(0)
  totalQuestions    Int                @default(0)
  startedAt         DateTime           @default(now())
  completedAt       DateTime?
  timeSpentSeconds  Int                @default(0)
  passed            Boolean?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  answers           QuizAnswer[]
  profile           AcademyUserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  quiz              Quiz               @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([quizId])
  @@index([status])
}

model QuizAnswer {
  id                String       @id @default(cuid())
  attemptId         String
  questionId        String
  selectedOptions   Json         @default("[]")
  textAnswer        String?
  isCorrect         Boolean?
  pointsAwarded     Int          @default(0)
  aiGradingScore    Float?
  aiGradingFeedback String?
  timeSpentSeconds  Int          @default(0)
  answeredAt        DateTime     @default(now())
  attempt           QuizAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question          QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@index([attemptId])
  @@index([questionId])
}

model CustomLocation {
  id              String             @id @default(cuid())
  profileId       String
  tenantId        String?
  academyTenantId String?
  placeId         String?
  name            String
  address         String?
  lat             Float
  lng             Float
  businessType    String?
  industry        String?
  description     String?
  researchData    Json?
  researchedAt    DateTime?
  icon            String             @default("üìç")
  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  academyTenant   AcademyTenant?     @relation(fields: [academyTenantId], references: [id], onDelete: Cascade)
  profile         AcademyUserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  scenarios       CustomScenario[]

  @@index([profileId])
  @@index([tenantId])
  @@index([academyTenantId])
  @@index([placeId])
}

model CustomScenario {
  id                     String                  @id @default(cuid())
  locationId             String
  profileId              String
  tenantId               String?
  academyTenantId        String?
  title                  String
  description            String
  businessContext        String
  difficulty             String
  technicalRequirements  Json                    @default("[]")
  complianceRequirements Json                    @default("[]")
  constraints            Json                    @default("[]")
  learningObjectives     Json                    @default("[]")
  tags                   Json                    @default("[]")
  estimatedMinutes       Int                     @default(60)
  maxPoints              Int                     @default(1000)
  companyInfo            Json?
  generatedBy            String                  @default("learning_agent")
  aiModel                String?
  isActive               Boolean                 @default(true)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  challenges             CustomChallenge[]
  coachingSessions       CustomCoachingSession[]
  flashcardDecks         CustomFlashcardDeck[]
  quizzes                CustomQuiz[]
  academyTenant          AcademyTenant?          @relation(fields: [academyTenantId], references: [id], onDelete: Cascade)
  location               CustomLocation          @relation(fields: [locationId], references: [id], onDelete: Cascade)
  attempts               CustomScenarioAttempt[]
  studyNotes             CustomStudyNotes[]

  @@index([locationId])
  @@index([profileId])
  @@index([tenantId])
  @@index([academyTenantId])
}

model CustomChallenge {
  id               String                    @id @default(cuid())
  scenarioId       String
  title            String
  description      String
  difficulty       String
  orderIndex       Int                       @default(0)
  points           Int                       @default(100)
  bonusPoints      Int                       @default(0)
  hints            Json                      @default("[]")
  successCriteria  Json                      @default("[]")
  awsServices      Json                      @default("[]")
  estimatedMinutes Int                       @default(15)
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt
  scenario         CustomScenario            @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  progress         CustomChallengeProgress[]

  @@index([scenarioId])
}

model CustomScenarioAttempt {
  id                  String                    @id @default(cuid())
  profileId           String
  scenarioId          String
  tenantId            String?
  academyTenantId     String?
  status              String                    @default("in_progress")
  startedAt           DateTime                  @default(now())
  lastActivityAt      DateTime                  @default(now())
  completedAt         DateTime?
  pointsEarned        Int                       @default(0)
  maxPoints           Int                       @default(0)
  activeTimeMinutes   Int                       @default(0)
  flashcardsCompleted Boolean                   @default(false)
  notesCompleted      Boolean                   @default(false)
  quizCompleted       Boolean                   @default(false)
  chatUsed            Boolean                   @default(false)
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  challengeProgress   CustomChallengeProgress[]
  academyTenant       AcademyTenant?            @relation(fields: [academyTenantId], references: [id], onDelete: Cascade)
  scenario            CustomScenario            @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([scenarioId])
  @@index([tenantId])
  @@index([academyTenantId])
}

model CustomChallengeProgress {
  id               String                @id @default(cuid())
  attemptId        String
  challengeId      String
  status           String                @default("locked")
  startedAt        DateTime?
  completedAt      DateTime?
  pointsEarned     Int                   @default(0)
  hintsUsed        Int                   @default(0)
  timeSpentMinutes Int                   @default(0)
  solution         Json?
  feedback         Json?
  attempt          CustomScenarioAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  challenge        CustomChallenge       @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([attemptId, challengeId])
  @@index([challengeId])
}

model CustomFlashcardDeck {
  id          String            @id @default(cuid())
  scenarioId  String
  title       String
  description String?
  generatedBy String            @default("ai")
  totalCards  Int               @default(0)
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  cards       CustomFlashcard[]
  scenario    CustomScenario    @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@index([scenarioId])
}

model CustomFlashcard {
  id          String              @id @default(cuid())
  deckId      String
  front       String
  back        String
  frontType   String              @default("text")
  backType    String              @default("text")
  tags        Json                @default("[]")
  difficulty  String              @default("medium")
  awsServices Json                @default("[]")
  orderIndex  Int                 @default(0)
  createdAt   DateTime            @default(now())
  deck        CustomFlashcardDeck @relation(fields: [deckId], references: [id], onDelete: Cascade)

  @@index([deckId])
}

model CustomStudyNotes {
  id          String         @id @default(cuid())
  scenarioId  String
  title       String
  content     String
  sections    Json           @default("[]")
  generatedBy String         @default("ai")
  awsServices Json           @default("[]")
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  scenario    CustomScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@index([scenarioId])
}

model CustomQuiz {
  id            String               @id @default(cuid())
  scenarioId    String
  title         String
  description   String?
  quizType      String               @default("standard")
  timeLimit     Int?
  passingScore  Int                  @default(70)
  questionCount Int                  @default(10)
  generatedBy   String               @default("ai")
  isActive      Boolean              @default(true)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  scenario      CustomScenario       @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  questions     CustomQuizQuestion[]

  @@index([scenarioId])
}

model CustomQuizQuestion {
  id           String     @id @default(cuid())
  quizId       String
  question     String
  questionType String     @default("multiple_choice")
  options      Json       @default("[]")
  explanation  String?
  difficulty   String     @default("medium")
  points       Int        @default(10)
  awsServices  Json       @default("[]")
  orderIndex   Int        @default(0)
  createdAt    DateTime   @default(now())
  quiz         CustomQuiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
}

model CustomCoachingSession {
  id            String                  @id @default(cuid())
  profileId     String
  scenarioId    String
  title         String                  @default("Coaching Session")
  status        String                  @default("active")
  messageCount  Int                     @default(0)
  startedAt     DateTime                @default(now())
  lastMessageAt DateTime?
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  messages      CustomCoachingMessage[]
  scenario      CustomScenario          @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([scenarioId])
}

model CustomCoachingMessage {
  id          String                @id @default(cuid())
  sessionId   String
  role        String
  content     String
  contentType String                @default("text")
  metadata    Json                  @default("{}")
  createdAt   DateTime              @default(now())
  session     CustomCoachingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

model AcademyKnowledgeSource {
  id             String                  @id
  summary        String?
  totalWordCount Int                     @default(0)
  title          String?
  category       String?
  awsServices    Json                    @default("[]")
  tags           Json                    @default("[]")
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  codeExamples   AcademyCodeExample[]
  chunks         AcademyKnowledgeChunk[]

  @@index([category])
}

model AcademyKnowledgeChunk {
  id          Int                    @id @default(autoincrement())
  url         String
  chunkNumber Int
  content     String
  metadata    Json                   @default("{}")
  sourceId    String
  embedding   Unsupported("vector")?
  createdAt   DateTime               @default(now())
  source      AcademyKnowledgeSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@unique([url, chunkNumber])
  @@index([sourceId])
  @@index([url])
}

model AcademyCodeExample {
  id          Int                    @id @default(autoincrement())
  url         String
  chunkNumber Int
  content     String
  summary     String
  metadata    Json                   @default("{}")
  sourceId    String
  embedding   Unsupported("vector")?
  createdAt   DateTime               @default(now())
  source      AcademyKnowledgeSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@unique([url, chunkNumber])
  @@index([sourceId])
}

model AcademyKnowledgeQA {
  id                  String                 @id @default(cuid())
  question            String
  questionVariants    Json                   @default("[]")
  answer              String
  category            String
  awsServices         Json                   @default("[]")
  migrationCategories Json                   @default("[]")
  tags                Json                   @default("[]")
  difficulty          String                 @default("intermediate")
  sourceChunkIds      Json                   @default("[]")
  externalLinks       Json                   @default("[]")
  isVerified          Boolean                @default(false)
  upvotes             Int                    @default(0)
  downvotes           Int                    @default(0)
  embedding           Unsupported("vector")?
  isActive            Boolean                @default(true)
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt

  @@index([category])
  @@index([isActive])
}

model AWSServiceReference {
  id                       String   @id @default(cuid())
  serviceName              String   @unique
  serviceCode              String   @unique
  fullName                 String
  category                 String
  shortDescription         String
  fullDescription          String?
  useCases                 Json     @default("[]")
  onPremEquivalents        Json     @default("[]")
  migrationCategory        String?
  pricingModel             String?
  hasFreeeTier             Boolean  @default(false)
  complianceCertifications Json     @default("[]")
  relatedServices          Json     @default("[]")
  docsUrl                  String?
  pricingUrl               String?
  iconUrl                  String?
  color                    String?
  isActive                 Boolean  @default(true)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@index([category])
  @@index([migrationCategory])
}

model MigrationPattern {
  id                  String   @id @default(cuid())
  name                String
  slug                String   @unique
  sourceType          String
  targetService       String
  migrationCategory   String
  shortDescription    String
  fullDescription     String
  steps               Json
  prerequisites       Json     @default("[]")
  awsServices         Json     @default("[]")
  complexity          String   @default("medium")
  estimatedHours      Int?
  risks               Json     @default("[]")
  considerations      Json     @default("[]")
  costFactors         Json     @default("[]")
  successCriteria     Json     @default("[]")
  relatedPatterns     Json     @default("[]")
  architectureDiagram String?
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([migrationCategory])
  @@index([sourceType])
  @@index([targetService])
}

model WellArchitectedPrinciple {
  id              String   @id @default(cuid())
  pillar          String
  name            String
  slug            String   @unique
  description     String
  bestPractices   Json     @default("[]")
  antiPatterns    Json     @default("[]")
  reviewQuestions Json     @default("[]")
  awsServices     Json     @default("[]")
  docsUrl         String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())

  @@index([pillar])
}

// Portfolio - stores user's completed challenge work for showcase
model AcademyPortfolio {
  id                    String              @id @default(cuid())
  profileId             String?
  title                 String
  description           String?
  status                String              @default("draft")
  type                  String              @default("generated")
  isExample             Boolean             @default(false)
  businessUseCase       String?
  problemStatement      String?
  solutionSummary       String?
  awsServices           Json                @default("[]")
  architectureDiagram   Json?
  diagramSvg            String?
  keyDecisions          Json                @default("[]")
  complianceAchieved    Json                @default("[]")
  challengeScore        Int                 @default(0)
  maxScore              Int                 @default(0)
  completionTimeMinutes Int                 @default(0)
  hintsUsed             Int                 @default(0)
  scenarioAttemptId     String?
  challengeProgressId   String?
  locationSlug          String?
  locationName          String?
  companyName           String?
  industry              String?
  pdfUrl                String?
  thumbnailUrl          String?
  generatedAt           DateTime?
  generationError       String?
  isPublic              Boolean             @default(false)
  shareCode             String?             @unique
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  profile               AcademyUserProfile? @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([status])
  @@index([type])
  @@index([isExample])
  @@index([isPublic])
}

// Diagram Audit Tips - "Tip Jar" for storing AI feedback on architecture diagrams
model DiagramAuditTip {
  id                  String @id @default(cuid())
  challengeProgressId String
  profileId           String

  // Audit result data
  auditScore Int // Score from 0-100
  category   String // "correct", "missing", "suggestion", "feedback"
  content    String // The actual tip/feedback text

  // Context
  diagramSnapshot     Json? // Optional: snapshot of diagram state when tip was given
  awsServicesInvolved Json  @default("[]") // AWS services related to this tip

  // User interaction
  isDismissed Boolean   @default(false)
  dismissedAt DateTime?
  isHelpful   Boolean? // User can mark tips as helpful or not
  userNotes   String? // User can add notes to tips

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  challengeProgress ChallengeProgress @relation(fields: [challengeProgressId], references: [id], onDelete: Cascade)

  @@index([challengeProgressId])
  @@index([profileId])
  @@index([isDismissed])
  @@index([category])
}
